<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bug 6468 - Code::Blocks History</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body role="document">
    <div class="navbar navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://www.codeblocks.org/">Code::Blocks</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../index.html">Home</a></li>
            <li class="active"><a href="../bugs.html">Bugs</a></li>
            <li><a href="../features.html">Features</a></li>
            <li><a href="../patches.html">Patches</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container" role="main">
      <div class="row">
        <div class="col-sm-8">
          <h3>Bug #6468 <small>2006-02-18 17:27:48</small></h3>
          <h4>orefa</h4>
          <p class="lead">Crashes using menu accelerators</p>
          <pre class="pre-scrollable">Build: Feb 17 2006, 23:32:37 - wx2.6.2(Windows, unicode)

I defined a help shortcut using Settings | Environment | Help Files | Add. The title starts with an ampersand: "&amp;Win32". When using Alt-H followed by Alt-W to reach this Win32 help file the application crashes. 

Dr. MinGW pops up with this content:

codeblocks.exe caused an Access Violation at location 77fb79fa in module ntdll.dll Reading from location ffffffff.

Registers:
eax=00770026 ebx=ffffffff ecx=00000004 edx=00772610 esi=ffffffff edi=ffffffff
eip=77fb79fa esp=0022e56c ebp=0022e594 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=0038  gs=0000             efl=00000202

Call stack:
77FB79FA  ntdll.dll:77FB79FA  strcat
77E313C2  USER32.dll:77E313C2  TileWindows
1011212C  wxmsw26u_gcc_cb.dll:1011212C  _ZN8wxWindow14HandleMenuCharEil
10113C70  wxmsw26u_gcc_cb.dll:10113C70  _ZN8wxWindow13MSWWindowProcEjjl
101390FA  wxmsw26u_gcc_cb.dll:101390FA  _ZN7wxFrame13MSWWindowProcEjjl
1010C750  wxmsw26u_gcc_cb.dll:1010C750  _Z9wxWndProcP6HWND__jjl@16
77E4158F  USER32.dll:77E4158F  IsCharAlphaNumericW
77E3C19D  USER32.dll:77E3C19D  DdeQueryStringA
77E3C1CA  USER32.dll:77E3C1CA  DdeQueryStringA
77F91BAF  ntdll.dll:77F91BAF  NtOpenProcessToken
77E3C159  USER32.dll:77E3C159  DdeQueryStringA
77E4158F  USER32.dll:77E4158F  IsCharAlphaNumericW
77E3AFA1  USER32.dll:77E3AFA1  CopyAcceleratorTableA
77E3AFC7  USER32.dll:77E3AFC7  CopyAcceleratorTableA
1010BE40  wxmsw26u_gcc_cb.dll:1010BE40  _ZN8wxWindow16MSWDefWindowProcEjjl
10180379  wxmsw26u_gcc_cb.dll:10180379  _ZN10wxTreeCtrl16MSWDefWindowProcEjjl
1011378C  wxmsw26u_gcc_cb.dll:1011378C  _ZN8wxWindow13MSWWindowProcEjjl
1017F023  wxmsw26u_gcc_cb.dll:1017F023  _ZN10wxTreeCtrl13MSWWindowProcEjjl
1010C750  wxmsw26u_gcc_cb.dll:1010C750  _Z9wxWndProcP6HWND__jjl@16
77E4158F  USER32.dll:77E4158F  IsCharAlphaNumericW
77E3C19D  USER32.dll:77E3C19D  DdeQueryStringA
77E3C1CA  USER32.dll:77E3C1CA  DdeQueryStringA
77F91BAF  ntdll.dll:77F91BAF  NtOpenProcessToken
77E3C159  USER32.dll:77E3C159  DdeQueryStringA
77E4158F  USER32.dll:77E4158F  IsCharAlphaNumericW
77E3AFA1  USER32.dll:77E3AFA1  CopyAcceleratorTableA
77E3AFC7  USER32.dll:77E3AFC7  CopyAcceleratorTableA
1010BE40  wxmsw26u_gcc_cb.dll:1010BE40  _ZN8wxWindow16MSWDefWindowProcEjjl
10180379  wxmsw26u_gcc_cb.dll:10180379  _ZN10wxTreeCtrl16MSWDefWindowProcEjjl
1011378C  wxmsw26u_gcc_cb.dll:1011378C  _ZN8wxWindow13MSWWindowProcEjjl
1017F023  wxmsw26u_gcc_cb.dll:1017F023  _ZN10wxTreeCtrl13MSWWindowProcEjjl
1010C750  wxmsw26u_gcc_cb.dll:1010C750  _Z9wxWndProcP6HWND__jjl@16
77E4158F  USER32.dll:77E4158F  IsCharAlphaNumericW
77E41DC9  USER32.dll:77E41DC9  IsCharAlphaNumericW
77E41E7E  USER32.dll:77E41E7E  IsCharAlphaNumericW
100EC7F4  wxmsw26u_gcc_cb.dll:100EC7F4  _ZN11wxEventLoop8DispatchEv
100EC590  wxmsw26u_gcc_cb.dll:100EC590  _ZN11wxEventLoop3RunEv
1018492E  wxmsw26u_gcc_cb.dll:1018492E  _ZN9wxAppBase8MainLoopEv
00404C6A  codeblocks.exe:00404C6A
10043817  wxmsw26u_gcc_cb.dll:10043817  _Z14wxUninitializev
100B33BA  wxmsw26u_gcc_cb.dll:100B33BA  _Z7wxEntryP11HINSTANCE__S0_Pci
004014DA  codeblocks.exe:004014DA
0045FEFA  codeblocks.exe:0045FEFA
00401237  codeblocks.exe:00401237
00401288  codeblocks.exe:00401288
7C598989  KERNEL32.dll:7C598989  BaseAttachCompleteThunk
</pre>
        </div>
        <div class="col-sm-4">
          <dl class="dl-horizontal">
            <dt>Category</dt><dd>Application::Crash</dd>
            <dt>Group</dt><dd>&nbsp;</dd>
            <dt>Status</dt><dd>Closed</dd>
            <dt>Close date</dt><dd>2006-05-05 08:42:09</dd>
            <dt>Assigned to</dt><dd>&nbsp;</dd>
          </dl>
        </div>
      </div>
      <h4 class="page-header">History</h4>
      <div class="panel panel-default">
        <div class="panel-heading">orefa 2006-02-18 17:33:24</div>
        <div class="panel-body">
          <p>Actually the &amp; is not the cause, the problem also arises without it.</p>
          <p>System: Windows 2000 5.00.2195 SP4, AMD Athlon</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">orefa 2006-02-18 17:39:49</div>
        <div class="panel-body">
          <p>The problem does not happen if C::B is closed and then re-started before the shortcut is used, only if it is used immediately after being defined.</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">orefa 2006-02-19 21:38:10</div>
        <div class="panel-body">
          <p>New observation: the Help menu is not specifically the cause. Doing Alt-F for the File menu followed by the 'F' key again (even if there is no particular menu option for this letter) also crashes CB.</p>
          <p>Tested on today's nightly build (CB_20060219_rev2040_win32.7z) too and obtained the same result.</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">ceniza 2006-02-19 23:42:16</div>
        <div class="panel-body">
          <p>Right, it has nothing to do with the help menu, neither the help plugin itself.</p>
          <p>I tried Alt+F F and got the crash immediately.</p>
          <p>It's incorrectly assigned to me with no way to change it.</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">pecan 2006-02-24 15:56:56</div>
        <div class="panel-body">
          <p>I disabled all plugins except compile; this still happens.</p>
          <p>winXPsp2 svn 2051</p>
          <p>(gdb) shows the following bt</p>
          <p>Program received signal SIGSEGV, Segmentation fault.</p>
          <p>0x7c910aa8 in wcsncpy () from ntdll.dll</p>
          <p>(gdb) bt</p>
          <p>#0  0x7c910aa8 in wcsncpy () from ntdll.dll</p>
          <p>#1  0x0000000b in ?? ()</p>
          <p>#2  0x0022e994 in ?? ()</p>
          <p>#3  0x0022e978 in ?? ()</p>
          <p>#4  0x77d6735e in USER32!GetMenuItemInfoW ()</p>
          <p>from C:\WINDOWS\system32\user32.dll</p>
          <p>#5  0xffffffff in ?? ()</p>
          <p>#6  0x00f9ef50 in ?? ()</p>
          <p>#7  0x0000000b in ?? ()</p>
          <p>#8  0x0022e9dc in ?? ()</p>
          <p>#9  0x0022e9dc in ?? ()</p>
          <p>#10 0x00000004 in ?? ()</p>
          <p>#11 0x0022e9c4 in ?? ()</p>
          <p>#12 0x77d67294 in USER32!GetMenuItemInfoW ()</p>
          <p>from C:\WINDOWS\system32\user32.dll</p>
          <p>#13 0x00f9eb68 in ?? ()</p>
          <p>#14 0x00000004 in ?? ()</p>
          <p>#15 0x00000001 in ?? ()</p>
          <p>#16 0x0022e994 in ?? ()</p>
          <p>#17 0x0000001d in ?? ()</p>
          <p>#18 0x00000030 in ?? ()</p>
          <p>#19 0x000001f0 in ?? ()</p>
          <p>#20 0x00000000 in ?? () from</p>
          <p>---Type &lt;return&gt; to continue, or q &lt;return&gt; to quit---</p>
          <p>#21 0x00000000 in ?? () from</p>
          <p>#22 0x00000000 in ?? () from</p>
          <p>#23 0x00000000 in ?? () from</p>
          <p>#24 0x00000000 in ?? () from</p>
          <p>#25 0x00000000 in ?? () from</p>
          <p>#26 0x00000000 in ?? () from</p>
          <p>#27 0xffffffff in ?? ()</p>
          <p>#28 0x0000000c in ?? ()</p>
          <p>#29 0x00000000 in ?? () from</p>
          <p>#30 0x0022ea24 in ?? ()</p>
          <p>#31 0x1011212c in wxmsw26u_gcc_cb!_ZN8wxWindow14HandleMenuCharEil ()</p>
          <p>from c:\Usr\Proj\cbBeta\trunk\src\devel\wxmsw26u_gcc_cb.dll</p>
          <p>Previous frame inner to this frame (corrupt stack?)</p>
          <p>(gdb)</p>
          <p>looks like a corrupt stack in wxWidgets, or the bt cant continue?</p>
          <p>pecan</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">pecan 2006-02-24 17:25:39</div>
        <div class="panel-body">
          <p>Is this the bug?? Looks like it wasn't fixed until Jan 13 this year.</p>
          <p>We might still have it in 2.6.1</p>
          <p><a href="http://lists.wxwidgets.org/cgi-bin/ezmlm-cgi?8:mss:86773:200601:omahhemelnkgfmllfnla">http://lists.wxwidgets.org/cgi-bin/ezmlm-cgi?8:mss:86773:200601:omahhemelnkgfmllfnla</a></p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">pecan 2006-02-24 18:14:10</div>
        <div class="panel-body">
          <p>This appears to be happening when the accelerator is _NOT_ defined in the menu. Alt F F in the file menus, as well as other menus crash when the accelerator is not defined. Defined accelerators work fine in winXPsp2 svn2051.</p>
          <p>HandleMenuchar() in window.cpp should never invoking windows. It should be passing back wxNOT_FOUND.</p>
          <p>Will trace through this in the afternoon.</p>
          <p>-pecan-</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">pecan 2006-02-24 21:21:46</div>
        <div class="panel-body">
          <p>I traced thru the window.cpp::HandleMenuChar() code. It is,  in fact, causing this err. MenuItemInfo.dwTypeData is not being cleared after its filled to 0xffffffff by a previous call to ::getMenuItemInfo(). It's then used as a memory address on the next call, causing the segfault. I cleared it by hand on each call, the menus then worked fine. But I don't know how to fix this for C::B. Its a wxWidgets bug.</p>
          <p>Zeitlin says he fixed this. I'd guess in 2.6.3, 'cuz it sure ain't fixed in 2.6.2</p>
          <p>info:</p>
          <p><a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/winui/winui/windowsuserinterface/resources/menus/menureference/menustructures/menuiteminfo.asp">http://msdn.microsoft.com/library/default.asp?url=/library/en-us/winui/winui/windowsuserinterface/resources/menus/menureference/menustructures/menuiteminfo.asp</a></p>
          <p>To retrieve a menu item of type MFT_STRING, first find the size of the string by setting the dwTypeData member of MENUITEMINFO to NULL and then calling GetMenuItemInfo. The value of cch+1 is the size needed. Then allocate a buffer of this size, place the pointer to the buffer in dwTypeData, increment cch, and call GetMenuItemInfo once again to fill the buffer with the string. If the retrieved menu item is of some other type, then GetMenuItemInfo sets the dwTypeData member to a value whose type is specified by the fType member.</p>
          <p>-pecan-</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">pecan 2006-02-24 23:48:36</div>
        <div class="panel-body">
          <pre class="pre-scrollable">This bug is fixed in 2.6.3-RC1 with the following line:
        mii.cch = 0;

in the window.cpp code causing Windows to reset  MenuItemInfo.dwTypeData:

   // find if we have this letter in any owner drawn item
    const int count = ::GetMenuItemCount(hmenu);
    for ( int i = 0; i &lt; count; i++ )
    {
        // previous loop iteration could modify it, reset it back before
        // calling GetMenuItemInfo() to prevent it from overflowing dwTypeData
        mii.cch = 0;

        if ( ::GetMenuItemInfo(hmenu, i, TRUE, &amp;mii) )
        {
...
-pecan-</pre>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">ID_24639 2006-03-30 21:18:08</div>
        <div class="panel-body">
          <p>Now that 2.6.3 is out can this bug be closed?</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">thomasdenk 2006-05-05 08:42:09</div>
        <div class="panel-body">
          <p>Closing bug report.</p>
          <p>It is a wxWidgets problem fixed in wxWidgets 2.6.3 (which will be the official version for Code::Blocks).</p>
        </div>
      </div>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
  </body>
</html>