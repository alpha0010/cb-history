<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bug 18695 - Code::Blocks History</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body role="document">
    <div class="navbar navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://www.codeblocks.org/">Code::Blocks</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../index.html">Home</a></li>
            <li class="active"><a href="../bugs.html">Bugs</a></li>
            <li><a href="../features.html">Features</a></li>
            <li><a href="../patches.html">Patches</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container" role="main">
      <div class="row">
        <div class="col-sm-8">
          <h3>Bug #18695 <small>2012-08-04 23:11</small></h3>
          <h4>ohir</h4>
          <p class="lead">Parsing GDB output failed</p>
          <pre class="pre-scrollable">Linux 2.6.32-41 i686 GNU/Linux
C::B version svn8150

GDB parser goes astray for certain kind of input (strings).
Watch head contains "Parsing GDB output failed for ..." error message.
Dereferenced struct view usually is incomplete.

Cause:
Unknown.
Seems like a bad (overeager) regexp code going into the content of the string.

How to replicate:

Watch dereferenced 't' in code below:

[code]
#include &lt;malloc.h&gt;

const char ok1[]="\"a\" .         b , c";
const char ok2[]="\"a\"           b   c";
const char ok3[]="\"a\"           b ; c";
const char ok4[]="\"a\"          b , c";
const char bad[]="\"a\"           b , c";
/* note 11: spaces between " and b. 10 spaces is ok. */
struct
test {
    const char*           s;
};

int
main(void) {

struct test *t;

t = calloc(1,sizeof(struct test));

t-&gt;s = ok1;
t-&gt;s = ok2;
t-&gt;s = ok3;
t-&gt;s = ok4;
t-&gt;s = bad;
t-&gt;s = ok4;

free(t);

return 0;
}
[/code]</pre>
        </div>
        <div class="col-sm-4">
          <dl class="dl-horizontal">
            <dt>Category</dt><dd>Debugger</dd>
            <dt>Group</dt><dd>Platform:All</dd>
            <dt>Status</dt><dd>Open</dd>
            <dt>Close date</dt><dd>&nbsp;</dd>
            <dt>Assigned to</dt><dd>tpetrov</dd>
          </dl>
        </div>
      </div>
      <h4 class="page-header">History</h4>
      <div class="panel panel-default">
        <div class="panel-heading">ohir 2012-08-04 23:23</div>
        <div class="panel-body">
          <p>As submit cleaner ate spaces within code, below is block</p>
          <p>of test strings with spaces represented by '-' char.</p>
          <p>If you are gonna to replicate test scenario, you need to</p>
          <p>replace '-' with spaces back.</p>
          <p>const-char-ok1[]="\"a\"-.---------b-,-c";</p>
          <p>const-char-ok2[]="\"a\"-----------b---c";</p>
          <p>const-char-ok3[]="\"a\"-----------b-;-c";</p>
          <p>const-char-ok4[]="\"a\"----------b-,-c";</p>
          <p>const-char-bad[]="\"a\"-----------b-,-c";</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">ohir 2012-08-05 12:50</div>
        <div class="panel-body">
          <pre class="pre-scrollable">in file: src/plugins/debuggergdb/parsewatchvalue.cpp
in function: line 113: GetNextToken

Seem that tokenizer did not get account for escape
char being at the start. It just skips opening \ .

Here is obvious patch:

--- parsewatchvalue.cpp.orig
+++ parsewatchvalue.cpp
@@ -122,6 +122,7 @@

     token.start = -1;
     bool in_quote = false;
+    bool escape_next = false;
     int open_braces = 0;
     struct BraceType { enum Enum { None, Angle, Square }; };
     BraceType::Enum brace_type = BraceType::None;
@@ -141,6 +142,11 @@
         token = Token(pos, pos + 1, Token::CloseBrace);
         return true;

+    case _T('\\'):
+        escape_next = true;
+        token.type = Token::String;
+        token.start = pos;
+        break;
     case _T('"'):
         in_quote = true;
         token.type = Token::String;
@@ -164,7 +170,6 @@
     }
     ++pos;

-    bool escape_next = false;
     while (pos &lt; static_cast&lt;int&gt;(str.length()))
     {
         if (open_braces == 0)

=================
I have no time to set up env for compiling C::B by myself,
so this patch was NOT tested.
</pre>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">ollydbg 2012-08-06 04:54</div>
        <div class="panel-body">
          <p>Hi, I can confirm the bug under Windows + gcc + gdb.</p>
          <p>But I see that gdb does not print the whole string buffer, somethings, it will print something like:</p>
          <p>[debug]{s = 0x40b0d3 "\"a\"", ' ' &lt;repeats 11 times&gt;, "b , c"}&gt;&gt;&gt;&gt;&gt;&gt;cb_gdb:</p>
          <p>Then, the gdb parser always stop after the "&gt;", I mean the "b , c" is not shown on the watches, this is another kind of bug, right?</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">ohir 2012-08-06 10:40</div>
        <div class="panel-body">
          <pre class="pre-scrollable">&gt;&gt;&gt;&gt;&gt;&gt; is the prompt as set by C::B.
I do not know if this is another kind of bug.

but I can tell that for parsing cited output tokenizer has another bug: It tries to check for repeated chars,
while "in_quote" state. That is wrong for output:
"\"a\"", ' ' &lt;repeats 11 times&gt;, "b , c"

because phrase &lt;repeats 11 times&gt; is NOT within if(in_quote) scope. \"a\" is in_quote, then quote closes. "b , c" again is in
quote.

 184:    if (in_quote)
                {
                    if (!escape_next)
                    {
                        int newPos = DetectRepeatingSymbols(str, pos);

Tokenizer code itself is enough convulted to have more quirks like that. Can't tell for the rest.

Someone needs to test it, um, with debugger step by step with enough sample outputs to see where and how assumptions and presumptions bent the code to fail.

</pre>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">ollydbg 2012-08-11 09:34</div>
        <div class="panel-body">
          <p>Indeed, it has the bug of strings.</p>
          <p>Currently, it both happens in Windows and Linux system, so I change the platform.</p>
          <p>BTW: Currently there is a on-going work of the gdb-mi plugin, but that may have the same issue. (if you have time, you can have a try)</p>
          <p><a href="http://forums.codeblocks.org/index.php/topic,16230.msg109713.html#msg109713" data-toggle="tooltip" title="Debugger plugin: GDB MI interface features and issues">http://forums.codeblocks.org/index.php/topic,16230.msg109713.html#msg109713</a></p>
          <p>Thanks for your detailed report.</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">ollydbg 2012-08-14 08:23</div>
        <div class="panel-body">
          <p>Hi, ohir, today, I have a chance to test the gdb-mi plugin for C::B, I can't find the bug you reported in the new plugin. If you are brave enough, you can use this gdb-mi plugin(build it from source), Thanks.</p>
        </div>
      </div>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script>
      $(document).ready(function() {
        $("body").tooltip({ selector: '[data-toggle=tooltip]' });
      });
    </script>
  </body>
</html>