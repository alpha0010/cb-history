<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Patch 2867 - Code::Blocks History</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css">
  </head>
  <body role="document">
    <div class="navbar navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://www.codeblocks.org/">Code::Blocks</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../index.html">Home</a></li>
            <li><a href="../bugs.html">Bugs</a></li>
            <li><a href="../features.html">Features</a></li>
            <li class="active"><a href="../patches.html">Patches</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container" role="main">
      <div class="row">
        <div class="col-sm-8">
          <h3>Patch #2867 <small>2009-12-20 20:10</small></h3>
          <h4>techy</h4>
          Try harder when searching file with compilation error
          <dl class="dl-horizontal">
            <dt>Download</dt>
            <dd><a href="2867-Try_harder_whe.patch">2867-Try_harder_whe.patch</a> (4.7 KB)</dd>
          </dl>
        </div>
        <div class="col-sm-4">
          <dl class="dl-horizontal">
            <dt>Category</dt><dd>Application::Refinement</dd>
            <dt>Status</dt><dd>Accepted</dd>
            <dt>Close date</dt><dd>2009-12-31 14:47 <a href="http://cb.biplab.in/websvn/log.php?sr=6012"><span class="glyphicon glyphicon-link"></span></a></dd>
            <dt>Assigned to</dt><dd>mortenmacfly</dd>
          </dl>
        </div>
      </div>
      <div class="highlight"><pre class="pre-scrollable"><span class="gh">Index: src/sdk/globals.cpp</span>
<span class="gh">===================================================================</span>
<span class="gd">--- src/sdk/globals.cpp    (revision 5986)</span>
<span class="gi">+++ src/sdk/globals.cpp    (working copy)</span>
<span class="gu">@@ -665,6 +665,64 @@</span>
     return result;
 }
 
<span class="gi">+// Checks whether &#39;suffix&#39; could be a suffix of &#39;path&#39; and therefore represents </span>
<span class="gi">+// the same path. This is used to check whether a relative path could represent</span>
<span class="gi">+// the same path as absolute path. For instance, for </span>
<span class="gi">+// suffix = sdk/globals.cpp</span>
<span class="gi">+// path = /home/user/codeblocks/trunk/src/sdk/globals.cpp</span>
<span class="gi">+// it returns true. The function expects that &#39;path&#39; is normalized and compares</span>
<span class="gi">+// &#39;path&#39; with &#39;suffix&#39; starting from the end of the path. When it reaches .. in </span>
<span class="gi">+// &#39;suffix&#39; it gives up (there is no way to check relative filename names </span>
<span class="gi">+// exactly) and if the path compared so far is identical, it returns true</span>
<span class="gi">+bool IsSuffixOfPath(wxFileName const &amp; suffix, wxFileName const &amp; path)</span>
<span class="gi">+{</span>
<span class="gi">+    if (path.GetFullName() != suffix.GetFullName())</span>
<span class="gi">+    {</span>
<span class="gi">+        return false;</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="gi">+    wxArrayString suffixDirArray = suffix.GetDirs();</span>
<span class="gi">+    wxArrayString pathDirArray = path.GetDirs();</span>
<span class="gi">+</span>
<span class="gi">+    int j = pathDirArray.GetCount() - 1;</span>
<span class="gi">+    for (int i = suffixDirArray.GetCount() - 1; i &gt;= 0; i--)</span>
<span class="gi">+    {</span>
<span class="gi">+        if (suffixDirArray[i] == _T(&quot;.&quot;) || suffixDirArray[i] == _T(&quot;&quot;))</span>
<span class="gi">+        {</span>
<span class="gi">+            // skip paths like /./././ and ////</span>
<span class="gi">+            continue;</span>
<span class="gi">+        }</span>
<span class="gi">+</span>
<span class="gi">+        if (j &lt; 0)</span>
<span class="gi">+        {</span>
<span class="gi">+            // suffix has more directories than path - cannot represent the same path</span>
<span class="gi">+            return false;</span>
<span class="gi">+        }</span>
<span class="gi">+</span>
<span class="gi">+        if (suffixDirArray[i] == _T(&quot;..&quot;))</span>
<span class="gi">+        {</span>
<span class="gi">+            // suffix contains &quot;..&quot; - from now on we cannot precisely determine </span>
<span class="gi">+            // whether suffix and path match - we assume that they do</span>
<span class="gi">+            return true;</span>
<span class="gi">+        }</span>
<span class="gi">+        else if (suffixDirArray[i] != pathDirArray[j])</span>
<span class="gi">+        {</span>
<span class="gi">+            // the corresponding directories of the two paths differ</span>
<span class="gi">+            return false;</span>
<span class="gi">+        }</span>
<span class="gi">+</span>
<span class="gi">+        j--;</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="gi">+    if (suffix.IsAbsolute() &amp;&amp; (j &gt;= 0 || suffix.GetVolume() != path.GetVolume()))</span>
<span class="gi">+    {</span>
<span class="gi">+        return false;</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="gi">+    // &#39;suffix&#39; is a suffix of &#39;path&#39;</span>
<span class="gi">+    return true;</span>
<span class="gi">+}</span>
<span class="gi">+</span>
 // function to check the common controls version
 // (should it be moved in sdk globals?)
 #ifdef __WXMSW__
<span class="gh">Index: src/include/globals.h</span>
<span class="gh">===================================================================</span>
<span class="gd">--- src/include/globals.h    (revision 5986)</span>
<span class="gi">+++ src/include/globals.h    (working copy)</span>
<span class="gu">@@ -184,6 +184,7 @@</span>
                                           bool showCreateDirButton = false); // where supported
 
 extern DLLIMPORT bool NormalizePath(wxFileName&amp; f,const wxString&amp; base);
<span class="gi">+extern DLLIMPORT bool IsSuffixOfPath(wxFileName const &amp; suffix, wxFileName const &amp; path);</span>
 
 extern DLLIMPORT wxString URLEncode(const wxString &amp;str);
 
<span class="gh">Index: src/plugins/compilergcc/compilererrors.cpp</span>
<span class="gh">===================================================================</span>
<span class="gd">--- src/plugins/compilergcc/compilererrors.cpp    (revision 5986)</span>
<span class="gi">+++ src/plugins/compilergcc/compilererrors.cpp    (working copy)</span>
<span class="gu">@@ -162,12 +162,52 @@</span>
         }
     }
 
<span class="gd">-    // if we reached here and ed is NULL, either the error file doesn&#39;t belong to a project,</span>
<span class="gd">-    // or can&#39;t be found for any other reason.</span>
<span class="gd">-    // check if we can open it directly...</span>
<span class="gi">+    // if we reached here and ed is NULL, the filename in the output isn&#39;t relative</span>
<span class="gi">+    // to the project root directory or doesn&#39;t belong to the project</span>
<span class="gi">+</span>
<span class="gi">+    // first check if we can open it directly...</span>
     if (!ed)
         ed = Manager::Get()-&gt;GetEditorManager()-&gt;Open(error.filename);
 
<span class="gi">+    // check if we find the file among opened files (highly probable for error</span>
<span class="gi">+    // messages since we are getting error for something we have just screwed up)</span>
<span class="gi">+    if (!ed)</span>
<span class="gi">+    {</span>
<span class="gi">+        for (int i = 0; i &lt; Manager::Get()-&gt;GetEditorManager()-&gt;GetEditorsCount(); ++i)</span>
<span class="gi">+        {</span>
<span class="gi">+            cbEditor* edit = Manager::Get()-&gt;GetEditorManager()-&gt;GetBuiltinEditor(i);</span>
<span class="gi">+            if (!edit)</span>
<span class="gi">+                continue;</span>
<span class="gi">+</span>
<span class="gi">+            ProjectFile* pf = edit-&gt;GetProjectFile();</span>
<span class="gi">+            if (!pf)</span>
<span class="gi">+                continue;</span>
<span class="gi">+</span>
<span class="gi">+            if (IsSuffixOfPath(error.filename, pf-&gt;file.GetFullPath()))</span>
<span class="gi">+            {</span>
<span class="gi">+                ed = Manager::Get()-&gt;GetEditorManager()-&gt;Open(pf-&gt;file.GetFullPath());</span>
<span class="gi">+                break;</span>
<span class="gi">+            }</span>
<span class="gi">+        }</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="gi">+    // finally go through the project files and try to find the file there</span>
<span class="gi">+    if (!ed &amp;&amp; project)</span>
<span class="gi">+    {</span>
<span class="gi">+        for (int i = 0; i &lt; project-&gt;GetFilesCount(); ++i)</span>
<span class="gi">+        {</span>
<span class="gi">+            ProjectFile* pf = project-&gt;GetFile(i);</span>
<span class="gi">+            if (!pf)</span>
<span class="gi">+                continue;</span>
<span class="gi">+</span>
<span class="gi">+            if (IsSuffixOfPath(error.filename, pf-&gt;file.GetFullPath()))</span>
<span class="gi">+            {</span>
<span class="gi">+                ed = Manager::Get()-&gt;GetEditorManager()-&gt;Open(pf-&gt;file.GetFullPath());</span>
<span class="gi">+                break;</span>
<span class="gi">+            }</span>
<span class="gi">+        }</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
     if (ed)
     {
         ed-&gt;Activate();
</pre></div>

      <h4 class="page-header">History</h4>
      <div class="panel panel-default">
        <div class="panel-heading">techy 2009-12-20 20:18</div>
        <div class="panel-body">
          <p>I guess that codeblocks works very well when it manages the whole project but when using custom makefiles there are several issues. One of them is that it cannot find the file where the compilation error occurred so it cannot open it and mark the line with the error. This is a problem for all automake generated projects where you want to point the make to the topmost project directory with the main make - however, inside the makefile it makes cd to project subdirectories so the compilation errors are without any path so the files cannot be found with codeblocks.</p>
          <p>This patch adds more checks to locate the file with errors - it tries to locate the file in the currently opened file list (highly probable that the file will be found there - we probably get this error because we have made some modifications) and then all project files. I added one function to globals.cpp that is used to check whether the reported file could be the same as the opened (or project) file. I put it into globals just because I use the same function in one more patch as well (if there is some better place where to put it, please do it).</p>
        </div>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
  </body>
</html>
