<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Patch 3345 - Code::Blocks History</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">

    <link rel="stylesheet" href="../pygments.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body role="document">
    <div class="navbar navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://www.codeblocks.org/">Code::Blocks</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../index.html">Home</a></li>
            <li><a href="../bugs.html">Bugs</a></li>
            <li><a href="../features.html">Features</a></li>
            <li class="active"><a href="../patches.html">Patches</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container" role="main">
      <div class="row">
        <div class="col-sm-8">
          <h3>Patch #3345 <small>2012-10-06 15:35:54</small></h3>
          <h4>koonschi</h4>
          Added code completion of declarations in for/if/while heads
          <dl class="dl-horizontal">
            <dt>Download</dt>
            <dd><a href="3345-Added_code_com.patch">3345-Added_code_com.patch</a> (9.3 KB)</dd>
          </dl>
        </div>
        <div class="col-sm-4">
          <dl class="dl-horizontal">
            <dt>Category</dt><dd>Application::Refinement</dd>
            <dt>Status</dt><dd>Accepted</dd>
            <dt>Close date</dt><dd>2012-12-21 07:41:34 <a href="http://cb.biplab.in/websvn/log.php?sr=8700"><span class="glyphicon glyphicon-link"></span></a></dd>
            <dt>Assigned to</dt><dd>ollydbg</dd>
          </dl>
        </div>
      </div>
      <div class="highlight"><pre class="pre-scrollable"><span class="gh">Index: plugins/codecompletion/parser/parserthread.cpp</span>
<span class="gh">===================================================================</span>
<span class="gd">--- plugins/codecompletion/parser/parserthread.cpp    (revision 8431)</span>
<span class="gi">+++ plugins/codecompletion/parser/parserthread.cpp    (working copy)</span>
<span class="gu">@@ -666,7 +666,8 @@</span>
                 if (!m_Options.useBuffer || m_Options.bufferSkipBlocks)
                     SkipToOneOfChars(ParserConsts::semicolonclbrace, true, true);
                 else
<span class="gd">-                    m_Tokenizer.GetToken(); // skip arguments</span>
<span class="gi">+                    HandleConditionalArguments();</span>
<span class="gi">+</span>
                 m_Str.Clear();
             }
             else
<span class="gu">@@ -682,7 +683,8 @@</span>
                 if (!m_Options.useBuffer || m_Options.bufferSkipBlocks)
                     SkipToOneOfChars(ParserConsts::semicolonclbrace, true, true);
                 else
<span class="gd">-                    m_Tokenizer.GetToken(); // skip arguments</span>
<span class="gi">+                    HandleForLoopArguments();</span>
<span class="gi">+</span>
                 m_Str.Clear();
             }
             else
<span class="gu">@@ -727,7 +729,8 @@</span>
                 if (!m_Options.useBuffer || m_Options.bufferSkipBlocks)
                     SkipToOneOfChars(ParserConsts::semicolonclbrace, true, true);
                 else
<span class="gd">-                    m_Tokenizer.GetToken(); // skip arguments</span>
<span class="gi">+                    HandleConditionalArguments();</span>
<span class="gi">+</span>
                 m_Str.Clear();
             }
             else if (token == ParserConsts::kw_const)
<span class="gu">@@ -2070,6 +2073,188 @@</span>
     }
 }
 
<span class="gi">+void ParserThread::HandleConditionalArguments()</span>
<span class="gi">+{</span>
<span class="gi">+    // if these aren&#39;t empty at this point, we have a syntax error</span>
<span class="gi">+    if (!m_Str.empty())</span>
<span class="gi">+        return;</span>
<span class="gi">+</span>
<span class="gi">+    if (!m_PointerOrRef.empty())</span>
<span class="gi">+        return;</span>
<span class="gi">+</span>
<span class="gi">+    if (!m_TemplateArgument.empty())</span>
<span class="gi">+        return;</span>
<span class="gi">+</span>
<span class="gi">+    // conditional arguments can look like this:</span>
<span class="gi">+    // (int i = 12)</span>
<span class="gi">+    // (Foo *bar = getFooBar())</span>
<span class="gi">+    // (var &lt;= 12 &amp;&amp; (getType() != 23))</span>
<span class="gi">+    wxString args = m_Tokenizer.GetToken();</span>
<span class="gi">+</span>
<span class="gi">+    // remove braces</span>
<span class="gi">+    if (args.StartsWith(_T(&quot;(&quot;)))</span>
<span class="gi">+        args = args.Mid(1, args.length() - 1);</span>
<span class="gi">+</span>
<span class="gi">+    if (args.EndsWith(_T(&quot;)&quot;)))</span>
<span class="gi">+        args = args.Mid(0, args.length() - 1);</span>
<span class="gi">+</span>
<span class="gi">+    // parse small tokens inside for loop head</span>
<span class="gi">+    TokenTree tree;</span>
<span class="gi">+    wxString fileName = m_Tokenizer.GetFilename();</span>
<span class="gi">+    Tokenizer smallTokenizer(&amp;tree);</span>
<span class="gi">+</span>
<span class="gi">+    smallTokenizer.InitFromBuffer(args, fileName, m_Tokenizer.GetLineNumber());</span>
<span class="gi">+</span>
<span class="gi">+    while (IS_ALIVE)</span>
<span class="gi">+    {</span>
<span class="gi">+        wxString token = smallTokenizer.GetToken();</span>
<span class="gi">+        if (token.empty())</span>
<span class="gi">+            break;</span>
<span class="gi">+</span>
<span class="gi">+        wxString peek = smallTokenizer.PeekToken();</span>
<span class="gi">+</span>
<span class="gi">+        if (peek.empty())</span>
<span class="gi">+        {</span>
<span class="gi">+            if (!m_Str.empty())</span>
<span class="gi">+            {</span>
<span class="gi">+                // remove template argument if there is one</span>
<span class="gi">+                wxString varType, templateArgs;</span>
<span class="gi">+                RemoveTemplateArgs(m_Str, varType, templateArgs);</span>
<span class="gi">+</span>
<span class="gi">+                m_Str = varType;</span>
<span class="gi">+                m_TemplateArgument = templateArgs;</span>
<span class="gi">+</span>
<span class="gi">+                Token *newToken = DoAddToken(tkVariable, token, smallTokenizer.GetLineNumber());</span>
<span class="gi">+                if (newToken &amp;&amp; !m_TemplateArgument.IsEmpty())</span>
<span class="gi">+                {</span>
<span class="gi">+                    ResolveTemplateArgs(newToken);</span>
<span class="gi">+                }</span>
<span class="gi">+                else</span>
<span class="gi">+                {</span>
<span class="gi">+                    TRACE(_T(&quot;HandleConditionalArguments() : Unable to create/add new token: &quot;) + token);</span>
<span class="gi">+                }</span>
<span class="gi">+            }</span>
<span class="gi">+</span>
<span class="gi">+            break;</span>
<span class="gi">+        }</span>
<span class="gi">+        else</span>
<span class="gi">+        {</span>
<span class="gi">+            if (token == ParserConsts::ref_chr || token == ParserConsts::ptr_chr)</span>
<span class="gi">+            {</span>
<span class="gi">+                m_PointerOrRef &lt;&lt; token;</span>
<span class="gi">+            }</span>
<span class="gi">+            else</span>
<span class="gi">+            {</span>
<span class="gi">+                if (!m_Str.empty())</span>
<span class="gi">+                    m_Str &lt;&lt; _T(&quot; &quot;);</span>
<span class="gi">+</span>
<span class="gi">+                m_Str &lt;&lt; token;</span>
<span class="gi">+            }</span>
<span class="gi">+        }</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="gi">+    m_Str.clear();</span>
<span class="gi">+    m_PointerOrRef.clear();</span>
<span class="gi">+    m_TemplateArgument.clear();</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+void ParserThread::HandleForLoopArguments()</span>
<span class="gi">+{</span>
<span class="gi">+    // if these aren&#39;t empty at this point, we have a syntax error</span>
<span class="gi">+    if (!m_Str.empty())</span>
<span class="gi">+        return;</span>
<span class="gi">+</span>
<span class="gi">+    if (!m_PointerOrRef.empty())</span>
<span class="gi">+        return;</span>
<span class="gi">+</span>
<span class="gi">+    if (!m_TemplateArgument.empty())</span>
<span class="gi">+        return;</span>
<span class="gi">+</span>
<span class="gi">+    // for loop heads look like this:</span>
<span class="gi">+    // ([init1 [, init2 ...] ] ; [cond1 [, cond2 ..]]; [mod1 [, mod2 ..]])</span>
<span class="gi">+    wxString args = m_Tokenizer.GetToken();</span>
<span class="gi">+</span>
<span class="gi">+    // remove braces</span>
<span class="gi">+    if (args.StartsWith(_T(&quot;(&quot;)))</span>
<span class="gi">+        args = args.Mid(1, args.length() - 1);</span>
<span class="gi">+    if (args.EndsWith(_T(&quot;)&quot;)))</span>
<span class="gi">+        args = args.Mid(0, args.length() - 1);</span>
<span class="gi">+</span>
<span class="gi">+    // parse small tokens inside for loop head</span>
<span class="gi">+    TokenTree tree;</span>
<span class="gi">+    wxString fileName = m_Tokenizer.GetFilename();</span>
<span class="gi">+    Tokenizer smallTokenizer(&amp;tree);</span>
<span class="gi">+</span>
<span class="gi">+    smallTokenizer.InitFromBuffer(args, fileName, m_Tokenizer.GetLineNumber());</span>
<span class="gi">+</span>
<span class="gi">+    while (IS_ALIVE)</span>
<span class="gi">+    {</span>
<span class="gi">+        wxString token = smallTokenizer.GetToken();</span>
<span class="gi">+        if (token.empty())</span>
<span class="gi">+            break;</span>
<span class="gi">+</span>
<span class="gi">+        wxString peek = smallTokenizer.PeekToken();</span>
<span class="gi">+</span>
<span class="gi">+        bool createNewToken = false;</span>
<span class="gi">+        bool finished = false;</span>
<span class="gi">+</span>
<span class="gi">+        if (peek == ParserConsts::comma)</span>
<span class="gi">+        {</span>
<span class="gi">+</span>
<em><strong>file truncated...</strong></em>
</pre></div>

      <h4 class="page-header">History</h4>
      <div class="panel panel-default">
        <div class="panel-heading">koonschi 2012-10-06 15:40:21</div>
        <div class="panel-body">
          <p>Added some whitespaces to meet the coding conventions</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">koonschi 2012-10-07 10:36:59</div>
        <div class="panel-body">
          <p>Templated declarations are now recognized correctly</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">koonschi 2012-10-07 10:45:40</div>
        <div class="panel-body">
          <p>Removed tabs and replaced them with whitespaces</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">koonschi 2012-10-09 09:59:54</div>
        <div class="panel-body">
          <p>Comments corrected</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">ollydbg 2012-10-10 09:50:50</div>
        <div class="panel-body">
          <p>Looks good to me, but I need more time to test it.</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">mortenmacfly 2012-12-16 14:48:44</div>
        <div class="panel-body">
          <p>...just for the record, testing, too (for some weeks now) - no issues so far.</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">ollydbg 2012-12-21 07:41:01</div>
        <div class="panel-body">
          <p>Applied in the trunk rev 8700. Thanks.</p>
        </div>
      </div>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
  </body>
</html>