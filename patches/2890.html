<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Patch 2890 - Code::Blocks History</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">

    <link rel="stylesheet" href="../pygments.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body role="document">
    <div class="navbar navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://www.codeblocks.org/">Code::Blocks</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../index.html">Home</a></li>
            <li><a href="../bugs.html">Bugs</a></li>
            <li><a href="../features.html">Features</a></li>
            <li class="active"><a href="../patches.html">Patches</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container" role="main">
      <div class="row">
        <div class="col-sm-8">
          <h3>Patch #2890 <small>2009-12-30 20:46:23</small></h3>
          <h4>techy</h4>
          Fix total system lockup when dialog appears
          <dl class="dl-horizontal">
            <dt>Download</dt>
            <dd><a href="2890-Fix_total_syst.patch">2890-Fix_total_syst.patch</a></dd>
          </dl>
        </div>
        <div class="col-sm-4">
          <dl class="dl-horizontal">
            <dt>Category</dt><dd>Application::Bugfix</dd>
            <dt>Status</dt><dd>Accepted</dd>
            <dt>Close date</dt><dd>2010-01-25 19:12:39</dd>
            <dt>Assigned to</dt><dd>mortenmacfly</dd>
          </dl>
        </div>
      </div>
      <div class="highlight"><pre class="pre-scrollable"><span class="gh">Index: src/sdk/wxscintilla/src/ScintillaWX.cpp</span>
<span class="gh">===================================================================</span>
<span class="gd">--- src/sdk/wxscintilla/src/ScintillaWX.cpp    (revision 6015)</span>
<span class="gi">+++ src/sdk/wxscintilla/src/ScintillaWX.cpp    (working copy)</span>
<span class="gu">@@ -893,6 +893,7 @@</span>
     SetFocusState(false);
     focusEvent = false;
     DestroySystemCaret();
<span class="gi">+    SetMouseCapture(false);</span>
 }
 
 void ScintillaWX::DoGainFocus(){
</pre></div>

      <h4 class="page-header">History</h4>
      <div class="panel panel-default">
        <div class="panel-heading">techy 2009-12-30 21:11:34</div>
        <div class="panel-body">
          <p>Hua, managed to track down this pretty ugly bug...</p>
          <p>What happened - when I modified some files outside of codeblocks and switched back to codeblocks, a dialog asking me whether the files should be reloaded appeared but the whole system got frozen - and I mean really the whole system - I couldn't click anything at all and couldn't use the keyboard either (fortunately I could switch to virtual console with ctrl+F2 and kill codeblocks from there). After some testing, I noticed that this happened only when I was fast enough and clicked  the editor before the reload message appeared.</p>
          <p>OK, this is the reason for this behaviour: wxscintilla calls CaptureMouse() on the scintilla window when you click it and ReleaseMouse() on button up. Works fine unless it's interrupted by something else - a modal dialog window for example. In this case, interesting thing happens - you can only work with the modal dialog (because it's modal) but you cannot because the window below it has the capture - total deadlock.</p>
          <p>So basically the main change of this path is that I release the mouse capture in ScintillaWX::DoLoseFocus(). I have also slightly simplified the SetMouseCapture and HaveMouseCapture methods so they are easier to reason about.</p>
          <p>This should also fix the thing described at the end of app.cpp - CheckForExternallyModifiedFiles() should be callable directly and the mouse shouldn't be in "selecting mode" because it shouldn't have capture any more. I'll post a patch for this when the current patch gets tested and approved.</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">mortenmacfly 2009-12-31 16:54:01</div>
        <div class="panel-body">
          <p>Very nice one... I am happy to test...</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">techy 2010-01-01 14:22:37</div>
        <div class="panel-body">
          <p>You can easily reproduce the original bug by making a selection of some code and while selecting it, pressing Ctrl+F (search dialog appears and everythong freezes).</p>
          <p>Looking at the patch again, I think that from scintilla point of view, SetMouseCapture(false) should come to SetFocusState() - then it's common for all platforms. I'll submit this patch to the scintilla developer and get some feedback from him.</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">techy 2010-01-03 20:04:42</div>
        <div class="panel-body">
          <p>If interested, here is the discussion I had with Neil Hodgson about the problem:</p>
          <p><a href="http://groups.google.com/group/scintilla-interest/browse_thread/thread/ef55d73b71bf1459">http://groups.google.com/group/scintilla-interest/browse_thread/thread/ef55d73b71bf1459</a></p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">mortenmacfly 2010-01-07 12:24:12</div>
        <div class="panel-body">
          <p>O... having applied this patch results in the following:</p>
          <p>If I scroll an editor using the scrollbar the text in the editor gets selected (???). This is surely a bug. So that's not a good solution... Any advise / update?!</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">techy 2010-01-07 15:35:11</div>
        <div class="panel-body">
          <p>Hmm, interesting - what exactly do you do? I can't reproduce this behavior - but it also could be platform-dependent...</p>
          <p>What may be worth trying is to revert this patch and only keep the call</p>
          <p>SetMouseCapture(false);</p>
          <p>in ScintillaWX::DoGainFocus(). The change made to the other functions was merely a simplification but possibly (for some unknown reason) not correct.</p>
          <p>Btw. thanks for the clarification of wxScintilla development on scintilla mailing list. Are there any plans for codeblocks to use STC instead of wxScintilla?</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">mortenmacfly 2010-01-08 11:07:06</div>
        <div class="panel-body">
          <p>It's on Windows (XP an Vista at least).</p>
          <p>All you need to do is the following:</p>
          <p>- open a project</p>
          <p>- open a file in an editor</p>
          <p>- point the cursor to any line (e.g. in the middle) of your code</p>
          <p>- scroll the editor using the scrollbars</p>
          <p>--&gt; The text in continuously being selected starting from the cursors position (meaning the selection increases / decreases the more you scroll).</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">techy 2010-01-11 00:33:36</div>
        <div class="panel-body">
          <p>OK, I can't reproduce it under Linux (and in the following two weeks I won't have enough time to install a development environment under Windows).</p>
          <p>However, I probably know why there is a difference between Windows and Linux - under Windows the scrollbar is a part of the window while under gtk it's a separate window. So under Windows even if you are using the scrollbar, it appears as if you were inside the window and had your mouse button pressed - and you get the selected text.</p>
          <p>Please try if what I have suggested in my previous post helps (it's a new revision of this patch). If it does, please let me know - it'll save a lot of my time not having to build codeblocks under Windows.</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">mortenmacfly 2010-01-11 17:18:32</div>
        <div class="panel-body">
          <p>...give me some time. I am rather busy atm. I'll report back.</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">mortenmacfly 2010-01-23 09:33:40</div>
        <div class="panel-body">
          <p>Seems to work that way. I've applied it in the scintilla branch which will be merged soon into trunk.</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">techy 2010-01-25 18:33:09</div>
        <div class="panel-body">
          <p>Good to hear!</p>
          <p>By the way, could you please apply 002802 to scintilla branch as well? It's the only issue that prevents codeblocks from being compiled by gcc 3.3.3 (and I'd guess the same holds for older gcc's as well). If you look at the patch, it just splits one line of declarations into two lines of equivalent declarations so no bug can be hidden here. I really wonder why the old gcc doesn't like that...</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">mortenmacfly 2010-01-25 19:12:39</div>
        <div class="panel-body">
          <p>Applied 002802 into trunk, scintilla branch is no longer active (was merged into trunk).</p>
        </div>
      </div>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
  </body>
</html>