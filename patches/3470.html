<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Patch 3470 - Code::Blocks History</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css">
  </head>
  <body role="document">
    <div class="navbar navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://www.codeblocks.org/">Code::Blocks</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../index.html">Home</a></li>
            <li><a href="../bugs.html">Bugs</a></li>
            <li><a href="../features.html">Features</a></li>
            <li class="active"><a href="../patches.html">Patches</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container" role="main">
      <div class="row">
        <div class="col-sm-8">
          <h3>Patch #3470 <small>2013-05-29 15:53</small></h3>
          <h4>sbezgodov</h4>
          Fix crash when finish dragging project file.
          <dl class="dl-horizontal">
            <dt>Download</dt>
            <dd><a href="3470-Fix_crash_when.patch">3470-Fix_crash_when.patch</a> (3.0 KB)</dd>
          </dl>
        </div>
        <div class="col-sm-4">
          <dl class="dl-horizontal">
            <dt>Category</dt><dd>Application::Bugfix</dd>
            <dt>Status</dt><dd>Accepted</dd>
            <dt>Close date</dt><dd>2013-10-10 23:42 <a href="http://cb.biplab.in/websvn/log.php?sr=9395"><span class="glyphicon glyphicon-link"></span></a></dd>
            <dt>Assigned to</dt><dd>alpha0010</dd>
          </dl>
        </div>
      </div>
      <div class="highlight"><pre class="pre-scrollable"><span class="gh">Index: sdk/projectmanager.cpp</span>
<span class="gh">===================================================================</span>
<span class="gd">--- sdk/projectmanager.cpp    (revision 9122)</span>
<span class="gi">+++ sdk/projectmanager.cpp    (working copy)</span>
<span class="gu">@@ -195,6 +195,7 @@</span>
     m_IsClosingProject(false),
     m_IsClosingWorkspace(false),
     m_InitialDir(_T(&quot;&quot;)),
<span class="gi">+    m_IsDraggingSelection( false ),</span>
     m_isCheckingForExternallyModifiedProjects(false),
     m_CanSendWorkspaceChanged(false),
     m_RunningPlugin(NULL)
<span class="gu">@@ -1782,11 +1783,14 @@</span>
 
 void ProjectManager::OnTreeBeginDrag(wxTreeEvent&amp; event)
 {
<span class="gd">-    size_t count = m_pTree-&gt;GetSelections(m_DraggingSelection);</span>
<span class="gi">+    m_IsDraggingSelection = true;</span>
<span class="gi">+</span>
<span class="gi">+    wxArrayTreeItemIds selection;</span>
<span class="gi">+    size_t count = m_pTree-&gt;GetSelections( selection );</span>
     for (size_t i = 0; i &lt; count; i++)
     {
         //what item do we start dragging?
<span class="gd">-        wxTreeItemId id = m_DraggingSelection[i];</span>
<span class="gi">+        wxTreeItemId id = selection[i];</span>
 
         if (!id.IsOk())
             return;
<span class="gu">@@ -1814,6 +1818,7 @@</span>
 void ProjectManager::OnTreeEndDrag(wxTreeEvent&amp; event)
 {
     wxTreeItemId to = event.GetItem();
<span class="gi">+    m_IsDraggingSelection = false;</span>
 
     // is the drag target valid?
     if (!to.IsOk())
<span class="gu">@@ -1829,10 +1834,11 @@</span>
     if (!prjTo)
         return;
 
<span class="gd">-    size_t count = m_DraggingSelection.Count();</span>
<span class="gi">+    wxArrayTreeItemIds selection;</span>
<span class="gi">+    size_t count = m_pTree-&gt;GetSelections( selection );</span>
     for (size_t i = 0; i &lt; count; i++)
     {
<span class="gd">-        wxTreeItemId from = m_DraggingSelection[i];</span>
<span class="gi">+        wxTreeItemId from = selection[i];</span>
 
         // is the item valid?
         if (!from.IsOk())
<span class="gu">@@ -1850,7 +1856,7 @@</span>
     }
 
     // allow only if the project approves
<span class="gd">-    if (!prjTo-&gt;NodeDragged(m_pTree, m_DraggingSelection, to))</span>
<span class="gi">+    if (!prjTo-&gt;NodeDragged(m_pTree, selection, to))</span>
         return;
 
     event.Allow();
<span class="gu">@@ -3334,10 +3340,9 @@</span>
     const wxKeyEvent&amp; key_event = event.GetKeyEvent();
 
     cbProject* project = GetActiveProject();
<span class="gd">-    if (    project</span>
<span class="gd">-        &amp;&amp; (project-&gt;GetCurrentlyCompilingTarget() == 0)</span>
<span class="gd">-        &amp;&amp; (   key_event.GetKeyCode() == WXK_DELETE</span>
<span class="gd">-            || key_event.GetKeyCode() == WXK_NUMPAD_DELETE ) )</span>
<span class="gi">+    int key = key_event.GetKeyCode();</span>
<span class="gi">+    if ( project &amp;&amp; ( project-&gt;GetCurrentlyCompilingTarget() == 0 ) &amp;&amp;</span>
<span class="gi">+         ( key == WXK_DELETE || key == WXK_NUMPAD_DELETE ) &amp;&amp; !m_IsDraggingSelection )</span>
     {
         wxCommandEvent command(0, idMenuRemoveFilePopup);
         OnRemoveFileFromProject(command);
<span class="gh">Index: include/projectmanager.h</span>
<span class="gh">===================================================================</span>
<span class="gd">--- include/projectmanager.h    (revision 9122)</span>
<span class="gi">+++ include/projectmanager.h    (working copy)</span>
<span class="gu">@@ -538,7 +538,7 @@</span>
         bool                 m_IsClosingProject;
         bool                 m_IsClosingWorkspace;
         wxString             m_InitialDir;
<span class="gd">-        wxArrayTreeItemIds   m_DraggingSelection;</span>
<span class="gi">+        bool                 m_IsDraggingSelection;</span>
         wxTreeItemId         m_RightClickItem;
         bool                 m_isCheckingForExternallyModifiedProjects;
         bool                 m_CanSendWorkspaceChanged;
</pre></div>

      <h4 class="page-header">History</h4>
      <div class="panel panel-default">
        <div class="panel-heading">sbezgodov 2013-05-29 16:02</div>
        <div class="panel-body">
          <p>Steps to reproduce:</p>
          <p>Open project.</p>
          <p>Select file in Projects pane.</p>
          <p>Press and hold left mouse button.</p>
          <p>Start dragging selected file.</p>
          <p>Press Del key. File will be removed immediately.</p>
          <p>Release mouse left button.</p>
          <p>Crash!</p>
          <p>This patch actually ignores Del key handling during item dragging in Projects tree.</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">alpha0010 2013-10-10 23:42</div>
        <div class="panel-body">
          <p>Committed, modified (logic reversed so that dragging is invalidated upon delete - key press interrupt is more likely the user's intent, as it was the most recent action).</p>
        </div>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
  </body>
</html>
