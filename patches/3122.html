<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Patch 3122 - Code::Blocks History</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css">
  </head>
  <body role="document">
    <div class="navbar navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://www.codeblocks.org/">Code::Blocks</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../index.html">Home</a></li>
            <li><a href="../bugs.html">Bugs</a></li>
            <li><a href="../features.html">Features</a></li>
            <li class="active"><a href="../patches.html">Patches</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container" role="main">
      <div class="row">
        <div class="col-sm-8">
          <h3>Patch #3122 <small>2011-01-21 12:50</small></h3>
          <h4>etheranger</h4>
          [Debugger branch] CDB bugfixes
          <dl class="dl-horizontal">
            <dt>Download</dt>
            <dd><a href="3122-Debugger_branc.patch">3122-Debugger_branc.patch</a> (8.4 KB)</dd>
          </dl>
        </div>
        <div class="col-sm-4">
          <dl class="dl-horizontal">
            <dt>Category</dt><dd>Application::Bugfix</dd>
            <dt>Status</dt><dd>Accepted</dd>
            <dt>Close date</dt><dd>2011-02-03 20:01 <a href="http://cb.biplab.in/websvn/log.php?sr=6956"><span class="glyphicon glyphicon-link"></span></a></dd>
            <dt>Assigned to</dt><dd>mortenmacfly</dd>
          </dl>
        </div>
      </div>
      <div class="highlight"><pre class="pre-scrollable"><span class="gh">Index: src/plugins/debuggergdb/cdb_commands.h</span>
<span class="gh">===================================================================</span>
<span class="gd">--- src/plugins/debuggergdb/cdb_commands.h    (revision 6930)</span>
<span class="gi">+++ src/plugins/debuggergdb/cdb_commands.h    (working copy)</span>
<span class="gu">@@ -20,6 +20,7 @@</span>
 #include &quot;disassemblydlg.h&quot;
 #include &quot;parsewatchvalue.h&quot;
 
<span class="gi">+static wxRegEx reProcessInf(_T(&quot;id:[ \t]+([A-Fa-f0-9]+)[ \t]+create&quot;));</span>
 static wxRegEx reWatch(_T(&quot;(\\+0x[A-Fa-f0-9]+ )&quot;));
 static wxRegEx reBT1(_T(&quot;([0-9]+) ([A-Fa-f0-9]+) ([A-Fa-f0-9]+) ([^[]*)&quot;));
 static wxRegEx reBT2(_T(&quot;\\[([A-z]:)(.*) @ ([0-9]+)\\]&quot;));
<span class="gu">@@ -127,15 +128,51 @@</span>
         }
 };
 
<span class="gi">+ /**</span>
<span class="gi">+  * Command to find the PID of the active child</span>
<span class="gi">+  */</span>
<span class="gi">+  class CdbCmd_GetPID : public DebuggerCmd</span>
<span class="gi">+{</span>
<span class="gi">+    public:</span>
<span class="gi">+        /** @param file The file to debug. */</span>
<span class="gi">+        CdbCmd_GetPID(DebuggerDriver* driver)</span>
<span class="gi">+            : DebuggerCmd(driver)</span>
<span class="gi">+        {</span>
<span class="gi">+            m_Cmd &lt;&lt; _T(&quot;|.&quot;);</span>
<span class="gi">+        }</span>
<span class="gi">+        void ParseOutput(const wxString&amp; output)</span>
<span class="gi">+        {</span>
<span class="gi">+            // Output:</span>
<span class="gi">+            // &lt;decimal process num&gt; id: &lt;hex PID&gt; create name: &lt;process name&gt;</span>
<span class="gi">+            wxArrayString lines = GetArrayFromString(output, _T(&#39;\n&#39;));</span>
<span class="gi">+            for (unsigned int i = 0; i &lt; lines.GetCount(); ++i)</span>
<span class="gi">+            {</span>
<span class="gi">+                if (reProcessInf.Matches(lines[i]))</span>
<span class="gi">+                {</span>
<span class="gi">+                    wxString hexID = reProcessInf.GetMatch(lines[i],1);</span>
<span class="gi">+</span>
<span class="gi">+                    long pid;</span>
<span class="gi">+                    if (hexID.ToLong(&amp;pid,16))</span>
<span class="gi">+                    {</span>
<span class="gi">+                        m_pDriver-&gt;SetChildPID(pid);</span>
<span class="gi">+                    }</span>
<span class="gi">+                }</span>
<span class="gi">+            }</span>
<span class="gi">+        }</span>
<span class="gi">+};</span>
<span class="gi">+</span>
 /**
   * Command to the attach to a process.
   */
 class CdbCmd_AttachToProcess : public DebuggerCmd
 {
<span class="gi">+    private:</span>
<span class="gi">+        int m_pid;</span>
     public:
         /** @param file The file to debug. */
         CdbCmd_AttachToProcess(DebuggerDriver* driver, int pid)
<span class="gd">-            : DebuggerCmd(driver)</span>
<span class="gi">+            : DebuggerCmd(driver),</span>
<span class="gi">+            m_pid(pid)</span>
         {
             m_Cmd &lt;&lt; _T(&quot;attach &quot;) &lt;&lt; wxString::Format(_T(&quot;%d&quot;), pid);
         }
<span class="gu">@@ -149,7 +186,10 @@</span>
             for (unsigned int i = 0; i &lt; lines.GetCount(); ++i)
             {
                 if (lines[i].StartsWith(_T(&quot;Attaching&quot;)))
<span class="gi">+                {</span>
                     m_pDriver-&gt;Log(lines[i]);
<span class="gi">+                    m_pDriver-&gt;SetChildPID(m_pid);</span>
<span class="gi">+                }</span>
                 else if (lines[i].StartsWith(_T(&quot;Can&#39;t &quot;)))
                 {
                     // log this and quit debugging
<span class="gu">@@ -181,6 +221,23 @@</span>
 };
 
 /**
<span class="gi">+  * Command to continue execution and notify the debugger plugin.</span>
<span class="gi">+  */</span>
<span class="gi">+class CdbCmd_Continue : public DebuggerCmd</span>
<span class="gi">+{</span>
<span class="gi">+    public:</span>
<span class="gi">+        /** @param bp The breakpoint to set. */</span>
<span class="gi">+        CdbCmd_Continue(DebuggerDriver* driver)</span>
<span class="gi">+            : DebuggerCmd(driver,_T(&quot;g&quot;))</span>
<span class="gi">+        {</span>
<span class="gi">+        }</span>
<span class="gi">+        virtual void Action()</span>
<span class="gi">+        {</span>
<span class="gi">+            m_pDriver-&gt;NotifyDebuggeeContinued();</span>
<span class="gi">+        }</span>
<span class="gi">+};</span>
<span class="gi">+</span>
<span class="gi">+/**</span>
   * Command to add a breakpoint.
   */
 class CdbCmd_AddBreakpoint : public DebuggerCmd
<span class="gh">Index: src/plugins/debuggergdb/cdb_driver.cpp</span>
<span class="gh">===================================================================</span>
<span class="gd">--- src/plugins/debuggergdb/cdb_driver.cpp    (revision 6930)</span>
<span class="gi">+++ src/plugins/debuggergdb/cdb_driver.cpp    (working copy)</span>
<span class="gu">@@ -22,9 +22,10 @@</span>
 #include &lt;globals.h&gt;
 #include &lt;infowindow.h&gt;
 
<span class="gd">-#define CDB_PROMPT0 _T(&quot;0:000&gt;&quot;)</span>
<span class="gd">-#define CDB_PROMPT1 _T(&quot;0:001&gt;&quot;)</span>
<span class="gi">+//#define DEBUG_CDB_COMMANDS</span>
<span class="gi">+#define ENABLE_WORKINGDIR_WORKAROUND</span>
 
<span class="gi">+static wxRegEx rePrompt(_T(&quot;([0-9]+:){1,2}[0-9]+&gt;&quot;));</span>
 static wxRegEx reBP(_T(&quot;Breakpoint ([0-9]+) hit&quot;));
 // one stack frame (to access current file; is there another way???)
 //  # ChildEBP RetAddr
<span class="gu">@@ -33,6 +34,7 @@</span>
 
 CDB_driver::CDB_driver(DebuggerGDB* plugin)
     : DebuggerDriver(plugin),
<span class="gi">+    m_Debuggee(wxEmptyString),</span>
     m_IsStarted(false)
 {
     //ctor
<span class="gu">@@ -72,7 +74,14 @@</span>
     cmd &lt;&lt; _T(&#39; &#39;) &lt;&lt; debuggee;
 
     if (!m_WorkingDir.IsEmpty())
<span class="gi">+    {</span>
         wxSetWorkingDirectory(m_WorkingDir);
<span class="gi">+#ifdef ENABLE_WORKINGDIR_WORKAROUND</span>
<span class="gi">+        // Because of the lack of ChDir functionality for a process which has already been launched,</span>
<span class="gi">+        // do a dodgy workaround by starting with a dummy version of the process, then starting in the right folder later.</span>
<span class="gi">+        m_Debuggee.assign(debuggee);</span>
<span class="gi">+#endif</span>
<span class="gi">+    }</span>
 
     return cmd;
 }
<span class="gu">@@ -116,7 +125,29 @@</span>
 
 void CDB_driver::Prepare(bool /*isConsole*/)
 {
<span class="gd">-    // default initialization</span>
<span class="gi">+    // The very first command won&#39;t get the right output back due to the spam on CDB launch.</span>
<span class="gi">+    // Throw in a dummy command to flush the output buffer.</span>
<span class="gi">+    m_QueueBusy = true;</span>
<span class="gi">+    QueueCommand(new DebuggerCmd(this,_T(&quot;.echo Clear buffer&quot;)),High);</span>
<span class="gi">+</span>
<span class="gi">+#ifdef ENABLE_WORKINGDIR_WORKAROUND</span>
<span class="gi">+    if (!m_Debuggee.IsEmpty())</span>
<span class="gi">+    {</span>
<span class="gi">+        // Workaround for setting the correct working dir:</span>
<span class="gi">+        wxString cmd = _T(&quot;.kill; .createdir &quot;);</span>
<span class="gi">+        cmd &lt;&lt; m_WorkingDir;</span>
<span class="gi">+        QueueCommand(new DebuggerCmd(this,cmd)); // Kill the process and CD to the right place</span>
<span class="gi">+</span>
<span class="gi">+</span>
<em><strong>file truncated...</strong></em>
</pre></div>

      <h4 class="page-header">History</h4>
      <div class="panel panel-default">
        <div class="panel-heading">etheranger 2011-01-21 12:56</div>
        <div class="panel-body">
          <p>Carry over most of my fixes to trunk, and some new ones in the branch:</p>
          <p>+ Added workaround to correctly set working dir (can still be disabled by #undefining ENABLE_WORKINGDIR_WORKAROUND.</p>
          <p>+ Grab the PID at launch so that process break / killing works - this allows setting breakpoints while running</p>
          <p>+ NotifyDebuggeeContinued on Continue so that the cursor doesn't disappear forever after setting breakpoints while running</p>
          <p>+ Slightly improve recognising breakpoint &amp; assert hits</p>
        </div>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
  </body>
</html>
