<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Patch 2797 - Code::Blocks History</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">

    <link rel="stylesheet" href="../pygments.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body role="document">
    <div class="navbar navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://www.codeblocks.org/">Code::Blocks</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../index.html">Home</a></li>
            <li><a href="../bugs.html">Bugs</a></li>
            <li><a href="../features.html">Features</a></li>
            <li class="active"><a href="../patches.html">Patches</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container" role="main">
      <div class="row">
        <div class="col-sm-8">
          <h3>Patch #2797 <small>2009-07-30 20:19:59</small></h3>
          <h4>techy</h4>
          Various memory problem fixes (part 3)
          <dl class="dl-horizontal">
            <dt>Download</dt>
            <dd><a href="2797-Various_memory.patch">2797-Various_memory.patch</a></dd>
          </dl>
        </div>
        <div class="col-sm-4">
          <dl class="dl-horizontal">
            <dt>Category</dt><dd>Application::Bugfix</dd>
            <dt>Status</dt><dd>Accepted</dd>
            <dt>Close date</dt><dd>2009-08-24 07:31:47 <a href="http://cb.biplab.in/websvn/log.php?sr=5742"><span class="glyphicon glyphicon-link"></span></a></dd>
            <dt>Assigned to</dt><dd>mortenmacfly</dd>
          </dl>
        </div>
      </div>
      <div class="highlight"><pre class="pre-scrollable"><span class="gh">Index: src/plugins/codecompletion/parser/tokenizer.h</span>
<span class="gh">===================================================================</span>
<span class="gd">--- src/plugins/codecompletion/parser/tokenizer.h    (revision 5716)</span>
<span class="gi">+++ src/plugins/codecompletion/parser/tokenizer.h    (working copy)</span>
<span class="gu">@@ -111,7 +111,10 @@</span>
         {
             ++m_TokenIndex;
             if (IsEOF())
<span class="gi">+            {</span>
<span class="gi">+                m_TokenIndex = m_BufferLen;</span>
                 return false;
<span class="gi">+            }</span>
 
             if (CurrentChar() == _T(&#39;\n&#39;))
                 ++m_LineNumber;
<span class="gu">@@ -121,7 +124,10 @@</span>
         {
             m_TokenIndex += amount;
             if (IsEOF())
<span class="gi">+            {</span>
<span class="gi">+                m_TokenIndex = m_BufferLen;</span>
                 return false;
<span class="gi">+            }</span>
 
             if (CurrentChar() == _T(&#39;\n&#39;))
                 ++m_LineNumber;
<span class="gu">@@ -136,12 +142,9 @@</span>
 
     wxChar CurrentCharMoveNext()
     {
<span class="gd">-        size_t i = m_TokenIndex++;</span>
<span class="gd">-</span>
         if(m_TokenIndex &lt; m_BufferLen)
<span class="gd">-            return m_Buffer.GetChar(i);</span>
<span class="gd">-        else</span>
<span class="gd">-            return 0;</span>
<span class="gi">+            m_TokenIndex++;</span>
<span class="gi">+        return CurrentChar();</span>
     };
 
     wxChar NextChar() const
<span class="gh">Index: src/plugins/codecompletion/parser/tokenizer.cpp</span>
<span class="gh">===================================================================</span>
<span class="gd">--- src/plugins/codecompletion/parser/tokenizer.cpp    (revision 5716)</span>
<span class="gi">+++ src/plugins/codecompletion/parser/tokenizer.cpp    (working copy)</span>
<span class="gu">@@ -100,8 +100,10 @@</span>
 bool Tokenizer::InitFromBuffer(const wxString&amp; buffer)
 {
     BaseInit();
<span class="gi">+    m_BufferLen = buffer.Length();</span>
<span class="gi">+    m_Buffer.Alloc(m_BufferLen + 1);</span>
     m_Buffer = buffer;
<span class="gd">-    m_BufferLen = buffer.Length();</span>
<span class="gi">+    m_Buffer += _T(&#39; &#39;);</span>
     m_IsOK = true;
     m_Filename.Clear();
     return true;
<span class="gu">@@ -140,14 +142,14 @@</span>
         // same code as in cbC2U() but with the addition of the string length (3rd param in unicode version)
         // and the fallback encoding conversion
 #if wxUSE_UNICODE
<span class="gd">-        m_Buffer = wxString(data, wxConvUTF8, m_BufferLen);</span>
<span class="gi">+        m_Buffer = wxString(data, wxConvUTF8, m_BufferLen + 1);</span>
         if (m_Buffer.Length() == 0)
         {
             // could not read as utf-8 encoding, try iso8859-1
<span class="gd">-            m_Buffer = wxString(data, wxConvISO8859_1, m_BufferLen);</span>
<span class="gi">+            m_Buffer = wxString(data, wxConvISO8859_1, m_BufferLen + 1);</span>
         }
 #else
<span class="gd">-        m_Buffer = wxString(data, m_BufferLen);</span>
<span class="gi">+        m_Buffer = wxString(data, m_BufferLen + 1);</span>
 #endif
 
         if (m_BufferLen != m_Buffer.Length())
<span class="gu">@@ -157,6 +159,10 @@</span>
             m_BufferLen = m_Buffer.Length();
 //            asm(&quot;int $3;&quot;);
         }
<span class="gi">+</span>
<span class="gi">+        // add &#39;sentinel&#39; to the end of the string (not counted to the length of the string)</span>
<span class="gi">+        m_Buffer += _T(&#39; &#39;);</span>
<span class="gi">+</span>
         return data != 0;
     };
 
<span class="gu">@@ -170,6 +176,13 @@</span>
         return false;
     m_BufferLen = m_Buffer.Length();
 
<span class="gi">+    // add &#39;sentinel&#39; to the end of the string (not counted to the length of the string)</span>
<span class="gi">+</span>
<span class="gi">+    // (In the above cbRead() we don&#39;t specify the allocated length of m_Buffer so the</span>
<span class="gi">+    // call below might force reallocation of the string. However the documentation of</span>
<span class="gi">+    // wxWidgets says that the available memory in string is always a multiple of 16,</span>
<span class="gi">+    // so we have only 1/16 probability that this happens)</span>
<span class="gi">+    m_Buffer += _T(&#39; &#39;);</span>
     return true;
 }
 
<span class="gu">@@ -296,7 +309,12 @@</span>
         wxChar last = PreviousChar();
         // if DOS line endings, we &#39;ve hit \r and we skip to \n...
         if (last == &#39;\r&#39;)
<span class="gd">-            last = m_Buffer.GetChar(m_TokenIndex - 2);</span>
<span class="gi">+        {</span>
<span class="gi">+            if (m_TokenIndex - 2 &gt;= 0)</span>
<span class="gi">+                last = m_Buffer.GetChar(m_TokenIndex - 2);</span>
<span class="gi">+            else</span>
<span class="gi">+                last = _T(&#39;\0&#39;);</span>
<span class="gi">+        }</span>
         if (IsEOF() || last != &#39;\\&#39;)
             break;
         else
</pre></div>

      <h4 class="page-header">History</h4>
      <div class="panel panel-default">
        <div class="panel-heading">techy 2009-07-30 20:32:42</div>
        <div class="panel-body">
          <p>In Tokenizer, the function</p>
          <p>bool Tokenizer::SkipToOneOfChars(const wxChar* chars, bool supportNesting)</p>
          <p>reads several consecutive characters from the buffer without testing whether it has reached EOF in between. When EOF occurs between these reads, SkipToOneOfChars() can read characters behind the end of the buffer.</p>
          <p>This could be fixed by adding a test to CurrentChar() whether it has reached EOF but as this function is used quite frequently, it could slow down the parsing. Instead I allocated the buffer with one extra "sentinel" byte at the end of the buffer where the movement stops when calling MoveToNextChar() and this byte's value is read over and over by CurrentChar(). As the sentinel value I used ' ' (I was considering using '\0' as well as wxString isn't null-terminated but the documentation of wxWidgets says that not all functions of wxString may work correctly when '\0' is present and ' ' is very neutral for the tokenizer as well)</p>
        </div>
      </div>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
  </body>
</html>