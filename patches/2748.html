<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Patch 2748 - Code::Blocks History</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css">
  </head>
  <body role="document">
    <div class="navbar navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://www.codeblocks.org/">Code::Blocks</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../index.html">Home</a></li>
            <li><a href="../bugs.html">Bugs</a></li>
            <li><a href="../features.html">Features</a></li>
            <li class="active"><a href="../patches.html">Patches</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container" role="main">
      <div class="row">
        <div class="col-sm-8">
          <h3>Patch #2748 <small>2009-04-28 18:11</small></h3>
          <h4>raybert</h4>
          workspace file improvements
          <dl class="dl-horizontal">
            <dt>Download</dt>
            <dd><a href="2748-workspace_file.patch">2748-workspace_file.patch</a> (14.1 KB)</dd>
          </dl>
        </div>
        <div class="col-sm-4">
          <dl class="dl-horizontal">
            <dt>Category</dt><dd>Application::Refinement</dd>
            <dt>Status</dt><dd>Closed</dd>
            <dt>Close date</dt><dd>2012-05-28 19:52 <a href="http://cb.biplab.in/websvn/log.php?sr=8020"><span class="glyphicon glyphicon-link"></span></a></dd>
            <dt>Assigned to</dt><dd>killerbot</dd>
          </dl>
        </div>
      </div>
      <div class="highlight"><pre class="pre-scrollable"><span class="gh">diff -r b79c5d3ddb2d .hgtags</span>
<span class="gd">--- a/.hgtags    Wed Apr 29 01:03:39 2009 -0400</span>
<span class="gi">+++ b/.hgtags    Wed Apr 29 11:01:44 2009 -0400</span>
<span class="gu">@@ -1,3 +1,5 @@</span>
 0389ce88fc3525b8d308d522505d939760b32905 svn-5550
 84d1ba9c5aca7dc5f46c3dc1df47c5f837b9e1dd baseline
 51788dfbc72159481063e7315beede4e7d119a4e baseline
<span class="gi">+b79c5d3ddb2dc39048b5eda39f3ae63e5eddcbfc baseline</span>
<span class="gi">+f10e24fc4d48f4a11261a6e7f159e8e0089942f7 workspace-patch-2</span>
<span class="gh">diff -r b79c5d3ddb2d src/include/cbworkspace.h</span>
<span class="gd">--- a/src/include/cbworkspace.h    Wed Apr 29 01:03:39 2009 -0400</span>
<span class="gi">+++ b/src/include/cbworkspace.h    Wed Apr 29 11:01:44 2009 -0400</span>
<span class="gu">@@ -107,14 +107,26 @@</span>
           * false, the workspace will be marked as unmodified.
           */
         virtual void SetModified(bool modified);
<span class="gi">+</span>
<span class="gi">+        /** @brief Set the preferred target for this workspace</span>
<span class="gi">+          */</span>
<span class="gi">+        virtual void SetPreferredTarget(const wxString &amp;target);</span>
<span class="gi">+</span>
<span class="gi">+        /** @brief Get the preferred target for this workspace</span>
<span class="gi">+          */</span>
<span class="gi">+        virtual wxString GetPreferredTarget() const { return m_PreferredTargetName; }</span>
<span class="gi">+</span>
     private:
         bool m_IsOK; // succeeded loading?
         bool m_IsDefault; // is this the Code::Blocks default workspace?
         bool m_Modified; // is it modified?
         wxFileName m_Filename; // filename
         wxString m_Title; // title
<span class="gi">+        wxString m_PreferredTargetName;</span>
 
         void Load(); // utility function
<span class="gi">+        bool SaveLayout();</span>
<span class="gi">+        bool LoadLayout();</span>
 };
 
 #endif // CBWORKSPACE_H
<span class="gh">diff -r b79c5d3ddb2d src/include/workspaceloader.h</span>
<span class="gd">--- a/src/include/workspaceloader.h    Wed Apr 29 01:03:39 2009 -0400</span>
<span class="gi">+++ b/src/include/workspaceloader.h    Wed Apr 29 11:01:44 2009 -0400</span>
<span class="gu">@@ -16,6 +16,9 @@</span>
 
         bool Open(const wxString&amp; filename, wxString&amp; Title);
         bool Save(const wxString&amp; title, const wxString&amp; filename);
<span class="gi">+</span>
<span class="gi">+        bool SaveLayout(const wxString&amp; filename);</span>
<span class="gi">+        bool LoadLayout(const wxString&amp; filename);</span>
 };
 
 #endif // WORKSPACELOADER_H
<span class="gh">diff -r b79c5d3ddb2d src/plugins/compilergcc/compilergcc.cpp</span>
<span class="gd">--- a/src/plugins/compilergcc/compilergcc.cpp    Wed Apr 29 01:03:39 2009 -0400</span>
<span class="gi">+++ b/src/plugins/compilergcc/compilergcc.cpp    Wed Apr 29 11:01:44 2009 -0400</span>
<span class="gu">@@ -1314,6 +1314,18 @@</span>
     }
 }
 
<span class="gi">+bool CompilerGCC::IsValidTarget(const wxString &amp;target) const</span>
<span class="gi">+{</span>
<span class="gi">+    if ( target.IsEmpty() )</span>
<span class="gi">+        return false;</span>
<span class="gi">+    if ( m_Targets.Index(target) == -1 )</span>
<span class="gi">+        return false;</span>
<span class="gi">+    ProjectBuildTarget *tgt = Manager::Get()-&gt;GetProjectManager()-&gt;GetActiveProject()-&gt;GetBuildTarget(target);</span>
<span class="gi">+    if ( tgt &amp;&amp; ! tgt-&gt;SupportsCurrentPlatform() )</span>
<span class="gi">+        return false;</span>
<span class="gi">+    return true;</span>
<span class="gi">+}</span>
<span class="gi">+</span>
 void CompilerGCC::DoRecreateTargetMenu()
 {
     if (!IsAttached())
<span class="gu">@@ -1341,9 +1353,14 @@</span>
             break;
 
         // find out the should-be-selected target
<span class="gd">-        wxString tgtStr = m_Project-&gt;GetActiveBuildTarget();</span>
<span class="gd">-        if (tgtStr.IsEmpty())</span>
<span class="gd">-            tgtStr = m_Project-&gt;GetFirstValidBuildTargetName(); // a default value</span>
<span class="gi">+        wxString preferredTarget = Manager::Get()-&gt;GetProjectManager()-&gt;GetWorkspace()-&gt;GetPreferredTarget();</span>
<span class="gi">+        wxString tgtStr = preferredTarget;</span>
<span class="gi">+        if ( ! IsValidTarget(tgtStr) )</span>
<span class="gi">+            tgtStr = m_Project-&gt;GetActiveBuildTarget();</span>
<span class="gi">+        if ( ! IsValidTarget(tgtStr) )</span>
<span class="gi">+            tgtStr = m_Project-&gt;GetFirstValidBuildTargetName(); // last-chance default</span>
<span class="gi">+        if ( preferredTarget.IsEmpty() )</span>
<span class="gi">+            Manager::Get()-&gt;GetProjectManager()-&gt;GetWorkspace()-&gt;SetPreferredTarget(tgtStr);</span>
 
         // fill the menu and combo
         for (size_t x = 0; x &lt; m_Targets.GetCount(); ++x)
<span class="gu">@@ -1434,7 +1451,9 @@</span>
     }
     for (int i = 0; i &lt; project-&gt;GetBuildTargetsCount(); ++i)
     {
<span class="gd">-        m_Targets.Add(project-&gt;GetBuildTarget(i)-&gt;GetTitle());</span>
<span class="gi">+        ProjectBuildTarget *tgt = project-&gt;GetBuildTarget(i);</span>
<span class="gi">+        if ( tgt-&gt;SupportsCurrentPlatform() )</span>
<span class="gi">+            m_Targets.Add( tgt-&gt;GetTitle() );</span>
     }
 
     // keep the index for the first real target
<span class="gu">@@ -3158,15 +3177,18 @@</span>
 
 void CompilerGCC::OnSelectTarget(wxCommandEvent&amp; event)
 {
<span class="gd">-    int sel = event.GetSelection();</span>
     if (event.GetId() == idToolTarget)
     {   // through the toolbar
<span class="gi">+        int sel = event.GetSelection();</span>
<span class="gi">+        Manager::Get()-&gt;GetProjectManager()-&gt;GetWorkspace()-&gt;SetPreferredTarget( GetTargetString(sel) );</span>
         DoUpdateTargetMenu(sel);
     }
     else
     {   // through Build-&gt;SelectTarget
<span class="gd">-        DoUpdateTargetMenu(event.GetId() - idMenuSelectTargetOther[0]);</span>
<span class="gd">-        m_ToolTarget-&gt;SetSelection(event.GetId() - idMenuSelectTargetOther[0]);</span>
<span class="gi">+        int i = event.GetId() - idMenuSelectTargetOther[0];</span>
<span class="gi">+        Manager::Get()-&gt;GetProjectManager()-&gt;GetWorkspace()-&gt;SetPreferredTarget( GetTargetString(i) );</span>
<span class="gi">+        DoUpdateTargetMenu(i);</span>
<span class="gi">+        m_ToolTarget-&gt;SetSelection(i);</span>
     }
 } // end of OnSelectTarget
 
<span class="gh">diff -r b79c5d3ddb2d src/plugins/compilergcc/compilergcc.h</span>
<span class="gd">--- a/src/plugins/compilergcc/compilergcc.h    Wed Apr 29 01:03:39 2009 -0400</span>
<span class="gi">+++ b/src/plugins/compilergcc/compilergcc.h    Wed Apr 29</span>
<em><strong>file truncated...</strong></em>
</pre></div>

      <h4 class="page-header">History</h4>
      <div class="panel panel-default">
        <div class="panel-heading">raybert 2009-04-28 18:27</div>
        <div class="panel-body">
          <p>This patch is intended mainly to avoid (arguably) unnecessary modifications to the workspace file that would impact the user's VCS with unnecessary commits.</p>
          <p>It also provides a couple of minor usability improvements.</p>
          <p>This patch is being discussed in the forum @ <a href="http://forums.codeblocks.org/index.php/topic,10395.msg71559.html#msg71559" data-toggle="tooltip" title="workspace file changes and source control">http://forums.codeblocks.org/index.php/topic,10395.msg71559.html#msg71559</a></p>
          <p>It addresses the following:</p>
          <p>* CB currently writes workspace files with paths that contain the native path separator for the platform it is running on.  When sharing the workspace across multiple platforms this sometimes results in a modified workspace file where the only change is the slashes.  This also makes it difficult to compare versions of files.  This patch forces forward slashes to be used consistently in the workspace file regardless of which platform CB is running on.</p>
          <p>* CB currently saves the active project to the workspace file.  This causes the same problems as discussed above.  This patch introduces a new file (*.workspace.layout) and saves the active project there instead of in the WS file.</p>
          <p>* CB currently changes the active build target whenever the active project is changed (if the newly activated project has a different active target).  This is confusing and error prone as the user isn't expecting the setting that he/she made to be changed without his/her knowledge.  To address this, this patch introduces the concept of a "preferred target".  Whenever the user selects a new build target the selection is saved internally as the "preferred target".  When the user changes the active project, CB will attempt to keep the "preferred target" active.  If the newly activated project doesn't have a target with the same name, its last active target is re-activated.  The "preferred target" is also saved in the new "workspace layout" file and re-used the next time the workspace is loaded.</p>
          <p>* This patch also prevents CB from listing build targets that are not supported on the current platform from appearing in the drop down box or the menu.  (Note: If the active project does not have any target that supports the current platform, the target list will be empty.)</p>
          <p>~ray</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">raybert 2009-04-29 15:09</div>
        <div class="panel-body">
          <p>Minor update that replaces warning dialogs for workspace layout file load/save failures with debug logging.  The load failure would happen whenever an old project was opened with a patched CB.  The workspace layout file is not vital for anything and therefore doesn't warrant a warning dialog.</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">killerbot 2012-05-28 19:52</div>
        <div class="panel-body">
          <p>applied</p>
        </div>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script>
      $(document).ready(function() {
        $("body").tooltip({ selector: '[data-toggle=tooltip]' });
      });
    </script>
  </body>
</html>
