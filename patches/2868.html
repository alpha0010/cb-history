<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Patch 2868 - Code::Blocks History</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">

    <link rel="stylesheet" href="../pygments.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body role="document">
    <div class="navbar navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://www.codeblocks.org/">Code::Blocks</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../index.html">Home</a></li>
            <li><a href="../bugs.html">Bugs</a></li>
            <li><a href="../features.html">Features</a></li>
            <li class="active"><a href="../patches.html">Patches</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container" role="main">
      <div class="row">
        <div class="col-sm-8">
          <h3>Patch #2868 <small>2009-12-20 20:33:22</small></h3>
          <h4>techy</h4>
          Try harder when opening includes from context menu
          <dl class="dl-horizontal">
            <dt>Download</dt>
            <dd><a href="2868-Try_harder_whe.patch">2868-Try_harder_whe.patch</a></dd>
          </dl>
        </div>
        <div class="col-sm-4">
          <dl class="dl-horizontal">
            <dt>Category</dt><dd>Plugin::Refinement</dd>
            <dt>Status</dt><dd>Accepted</dd>
            <dt>Close date</dt><dd>2009-12-31 14:50:37</dd>
            <dt>Assigned to</dt><dd>mortenmacfly</dd>
          </dl>
        </div>
      </div>
      <div class="highlight"><pre class="pre-scrollable"><span class="gh">Index: src/plugins/codecompletion/codecompletion.cpp</span>
<span class="gh">===================================================================</span>
<span class="gd">--- src/plugins/codecompletion/codecompletion.cpp    (revision 5986)</span>
<span class="gi">+++ src/plugins/codecompletion/codecompletion.cpp    (working copy)</span>
<span class="gu">@@ -1896,45 +1896,78 @@</span>
         parser = m_NativeParser.FindParserFromActiveProject(); // get parser of active project, then
     }
 
<span class="gi">+    wxArrayString foundSet;</span>
     if (parser)
     {
         // search in all parser&#39;s include dirs
<span class="gd">-        wxString tmp;</span>
<span class="gd">-        wxArrayString FoundSet = parser-&gt;FindFileInIncludeDirs(NameUnderCursor);</span>
<span class="gd">-        if(FoundSet.GetCount() &gt; static_cast&lt;size_t&gt;(1))</span>
<span class="gd">-        {    // more then 1 hit : let the user choose</span>
<span class="gd">-            SelectIncludeFile Dialog(Manager::Get()-&gt;GetAppWindow());</span>
<span class="gd">-            Dialog.AddListEntries(FoundSet);</span>
<span class="gd">-            PlaceWindow(&amp;Dialog);</span>
<span class="gd">-            if(Dialog.ShowModal() == wxID_OK)</span>
<span class="gi">+        foundSet = parser-&gt;FindFileInIncludeDirs(NameUnderCursor);</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="gi">+    // look in the same dir as the source file</span>
<span class="gi">+    wxFileName fname = NameUnderCursor;</span>
<span class="gi">+    NormalizePath(fname, LastIncludeFileFrom);</span>
<span class="gi">+    if (wxFileExists(fname.GetFullPath()) )</span>
<span class="gi">+    {</span>
<span class="gi">+        foundSet.Add(fname.GetFullPath());</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="gi">+    // search for the file in project files</span>
<span class="gi">+    cbProject* project = Manager::Get()-&gt;GetProjectManager()-&gt;GetActiveProject();</span>
<span class="gi">+    if (project)</span>
<span class="gi">+    {</span>
<span class="gi">+        for (int i = 0; i &lt; project-&gt;GetFilesCount(); ++i)</span>
<span class="gi">+        {</span>
<span class="gi">+            ProjectFile* pf = project-&gt;GetFile(i);</span>
<span class="gi">+            if (!pf)</span>
<span class="gi">+                continue;</span>
<span class="gi">+</span>
<span class="gi">+            if (IsSuffixOfPath(NameUnderCursor, pf-&gt;file.GetFullPath()))</span>
             {
<span class="gd">-              tmp = Dialog.GetIncludeFile();</span>
<span class="gi">+                foundSet.Add(pf-&gt;file.GetFullPath());</span>
             }
<span class="gi">+        }</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="gi">+    // Remove duplicates</span>
<span class="gi">+    for (int i = 0; i &lt; foundSet.Count() - 1; i++)</span>
<span class="gi">+    {</span>
<span class="gi">+        for (int j = i + 1; j &lt; foundSet.Count(); )</span>
<span class="gi">+        {</span>
<span class="gi">+            if (foundSet.Item(i) == foundSet.Item(j))</span>
<span class="gi">+            {</span>
<span class="gi">+                foundSet.RemoveAt(j);</span>
<span class="gi">+            }</span>
             else
             {
<span class="gd">-                return; // user cancelled the dialog...</span>
<span class="gi">+                j++;</span>
             }
         }
<span class="gd">-        else if(FoundSet.GetCount())</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="gi">+    wxString selectedFile;</span>
<span class="gi">+    if (foundSet.GetCount() &gt; 1)</span>
<span class="gi">+    {    // more than 1 hit : let the user choose</span>
<span class="gi">+        SelectIncludeFile Dialog(Manager::Get()-&gt;GetAppWindow());</span>
<span class="gi">+        Dialog.AddListEntries(foundSet);</span>
<span class="gi">+        PlaceWindow(&amp;Dialog);</span>
<span class="gi">+        if(Dialog.ShowModal() == wxID_OK)</span>
         {
<span class="gd">-            tmp = FoundSet[0];</span>
<span class="gi">+            selectedFile = Dialog.GetIncludeFile();</span>
         }
<span class="gd">-</span>
<span class="gd">-        if (!tmp.IsEmpty())</span>
<span class="gi">+        else</span>
         {
<span class="gd">-            EditorManager* edMan = Manager::Get()-&gt;GetEditorManager();</span>
<span class="gd">-            edMan-&gt;Open(tmp);</span>
<span class="gd">-            return;</span>
<span class="gi">+            return; // user cancelled the dialog...</span>
         }
     }
<span class="gi">+    else if (foundSet.GetCount() == 1)</span>
<span class="gi">+    {</span>
<span class="gi">+        selectedFile = foundSet[0];</span>
<span class="gi">+    }</span>
 
<span class="gd">-    // look in the same dir as the source file</span>
<span class="gd">-    wxFileName fname = NameUnderCursor;</span>
<span class="gd">-    fname.Assign(wxFileName(LastIncludeFileFrom).GetPath(wxPATH_GET_SEPARATOR) + NameUnderCursor);</span>
<span class="gd">-    if (wxFileExists(fname.GetFullPath()))</span>
<span class="gi">+    if (!selectedFile.IsEmpty())</span>
     {
         EditorManager* edMan = Manager::Get()-&gt;GetEditorManager();
<span class="gd">-        edMan-&gt;Open(fname.GetFullPath());</span>
<span class="gi">+        edMan-&gt;Open(selectedFile);</span>
         return;
     }
 
</pre></div>

      <h4 class="page-header">History</h4>
      <div class="panel panel-default">
        <div class="panel-heading">techy 2009-12-20 20:41:49</div>
        <div class="panel-body">
          <p>Very similar problem to the previous patch - the project I'm working on at work is divided into several repositories (directories) and every repository into several subsystems (again new set of directories). Includes are relative to repositories so codeblocks can't find and open the includes (actually the same happens for the codeblocks project itself, just try to open the includes within "" in codecompletion.cpp - it will fail).</p>
          <p>The approach taken here is very similar to the previous patch, the only difference is that the found entries are put into list and all of them presented to the user. Before, all duplicates are removed from the list if there are any.</p>
          <p>You'll need to apply the previous patch - this patch uses the function that the previous patch puts into globals.cpp.</p>
        </div>
      </div>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
  </body>
</html>