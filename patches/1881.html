<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Patch 1881 - Code::Blocks History</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="../pygments.css">
  </head>
  <body role="document">
    <div class="navbar navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://www.codeblocks.org/">Code::Blocks</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../index.html">Home</a></li>
            <li><a href="../bugs.html">Bugs</a></li>
            <li><a href="../features.html">Features</a></li>
            <li class="active"><a href="../patches.html">Patches</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container" role="main">
      <div class="row">
        <div class="col-sm-8">
          <h3>Patch #1881 <small>2007-02-10 16:49</small></h3>
          <h4>pecan</h4>
          Fix for Debugger termination crashes
          <dl class="dl-horizontal">
            <dt>Download</dt>
            <dd><a href="1881-Fix_for_Debugg.patch">1881-Fix_for_Debugg.patch</a> (2.0 KB)</dd>
          </dl>
        </div>
        <div class="col-sm-4">
          <dl class="dl-horizontal">
            <dt>Category</dt><dd>&nbsp;</dd>
            <dt>Status</dt><dd>Rejected</dd>
            <dt>Close date</dt><dd>2007-06-27 10:53</dd>
            <dt>Assigned to</dt><dd>&nbsp;</dd>
          </dl>
        </div>
      </div>
      <div class="highlight"><pre class="pre-scrollable">The follow fixes Bug reports 9655 &amp; 10077 crashes in Debugger

The problem occurs when OnGDBTerminate frees m_pDriver while OnGDBOutput still has messages to process.

<span class="gh">Index: debuggergdb.cpp</span>
<span class="gh">===================================================================</span>
<span class="gd">--- debuggergdb.cpp    (revision 3590)</span>
<span class="gi">+++ debuggergdb.cpp    (working copy)</span>
<span class="gu">@@ -227,7 +227,8 @@</span>
     m_pBreakpointsWindow(0),
     m_pExamineMemoryDlg(0),
     m_pThreadsDlg(0),
<span class="gd">-    m_pProject(0)</span>
<span class="gi">+    m_pProject(0),</span>
<span class="gi">+    m_GDBInputKnt(0)</span>
 {
     if(!Manager::LoadResource(_T(&quot;debugger.zip&quot;)))
     {
<span class="gu">@@ -1909,12 +1910,19 @@</span>
 
 void DebuggerGDB::OnGDBOutput(wxCommandEvent&amp; event)
 {
<span class="gi">+    ++m_GDBInputKnt;</span>
     wxString msg = event.GetString();
     if (!msg.IsEmpty())
     {
 //        Manager::Get()-&gt;GetMessageManager()-&gt;Log(m_PageIndex, _T(&quot;O&gt;&gt;&gt; %s&quot;), msg.c_str());
         ParseOutput(msg);
     }
<span class="gi">+    --m_GDBInputKnt;</span>
<span class="gi">+    if ( (not m_pProcess) &amp;&amp; m_State.HasDriver() &amp;&amp; (m_GDBInputKnt==0) )</span>
<span class="gi">+    {   m_State.StopDriver();</span>
<span class="gi">+        DebugLog(wxT(&quot;ParseOutput() closed m_State.Driver&quot;));</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
 }
 
 void DebuggerGDB::OnGDBError(wxCommandEvent&amp; event)
<span class="gu">@@ -1937,7 +1945,14 @@</span>
 //    m_pProcess = 0L;
 
     ClearActiveMarkFromAllEditors();
<span class="gd">-    m_State.StopDriver();</span>
<span class="gi">+    // closing the GDB driver here causes crashes because input msgs</span>
<span class="gi">+    // are still queued up in OnGDBOutput/ParseOutput //(pecan 2007/2/09)</span>
<span class="gi">+    //-m_State.StopDriver();</span>
<span class="gi">+    if ( (not m_pProcess) &amp;&amp; m_State.HasDriver() &amp;&amp; (m_GDBInputKnt==0) )</span>
<span class="gi">+    {   m_State.StopDriver();</span>
<span class="gi">+        DebugLog(wxT(&quot;OnGDBTerminate() closed m_State.Driver&quot;));</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
     Manager::Get()-&gt;GetMessageManager()-&gt;Log(m_PageIndex, _(&quot;Debugger finished with status %d&quot;), m_LastExitCode);
 
     if (m_NoDebugInfo)
<span class="gh">Index: debuggergdb.h</span>
<span class="gh">===================================================================</span>
<span class="gd">--- debuggergdb.h    (revision 3590)</span>
<span class="gi">+++ debuggergdb.h    (working copy)</span>
<span class="gu">@@ -204,6 +204,7 @@</span>
         SearchDirsMap m_SearchDirs;
 
         int m_HookId; // project loader hook ID
<span class="gi">+        int m_GDBInputKnt;</span>
 
         DECLARE_EVENT_TABLE()
 };
</pre></div>

      <h4 class="page-header">History</h4>
      <div class="panel panel-default">
        <div class="panel-heading">pecan 2007-02-10 17:06</div>
        <div class="panel-body">
          <pre class="pre-scrollable">The following program can reproduce this bug in two ways.
The first just waits for input, hit the stop button, then crash.
The second put the pgm in a sleep loop. Hit the stop button, crash.



#include &lt;iostream&gt;
#include &lt;cstdlib&gt;
#include &lt;cstring&gt;

using namespace std;

int upstring(char *value);


int main()
{
    //asm("int3");
	char value[81]={'\0'};
	int upper_count;

	// perform i/o operation
	do
    {   cout &lt;&lt; "Please type in a String (max. 80 characters): ";
        cin.getline(value, 80);
        upper_count = upstring(value);
        cout &lt;&lt; upper_count &lt;&lt; " characters are converted" &lt;&lt; endl;
        cout &lt;&lt; "The new string is now: " &lt;&lt; value &lt;&lt; endl;
        if ( (strlen(value) &gt;3) &amp;&amp; (0==strncmp(value,"LOOP",4) ))
            break;
    }while(upper_count);

    // perform infinite loop if user entered text "loop"
    if ( (strlen(value) &gt;3) &amp;&amp; (0==strncmp(value,"LOOP",4)) )
    {
        int i = 0;
        while(true){
            cout&lt;&lt;".";cout.flush();
            ++i;
            sleep(1);
        }
    }
  return EXIT_SUCCESS;
}

int upstring(char *value)
{
  int i=0;
  while(*value)
  {
    if(islower(*value))
    {
      *value=toupper(*value);
      i++;
    }
  value++;
  }
  return(i);
}
</pre>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">pecan 2007-03-02 18:18</div>
        <div class="panel-body">
          <p>Fixed by SVN 3659</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">rickg22 2007-06-26 23:23</div>
        <div class="panel-body">
          <p>Pecan, what's the status of this patch? Was the bug fixed in trunk or not? I need to know so I can close <a href="../bugs/9655.html" data-toggle="tooltip" title="Project switching during debug">Bug #9655</a>.</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">pecan 2007-06-27 10:53</div>
        <div class="panel-body">
          <p>This bug was fixed in another way by mandrav.</p>
        </div>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script>
      $(document).ready(function() {
        $("body").tooltip({ selector: '[data-toggle=tooltip]' });
      });
    </script>
  </body>
</html>
