<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Patch 3493 - Code::Blocks History</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">

    <link rel="stylesheet" href="../pygments.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body role="document">
    <div class="navbar navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://www.codeblocks.org/">Code::Blocks</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../index.html">Home</a></li>
            <li><a href="../bugs.html">Bugs</a></li>
            <li><a href="../features.html">Features</a></li>
            <li class="active"><a href="../patches.html">Patches</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container" role="main">
      <div class="row">
        <div class="col-sm-8">
          <h3>Patch #3493 <small>2013-08-24 19:37:06</small></h3>
          <h4>enter_cze</h4>
          Use standard (if set) when adding GCC built-in defines
          <dl class="dl-horizontal">
            <dt>Download</dt>
            <dd><a href="3493-Use_standard_i.patch">3493-Use_standard_i.patch</a> (5.0 KB)</dd>
          </dl>
        </div>
        <div class="col-sm-4">
          <dl class="dl-horizontal">
            <dt>Category</dt><dd>Plugin::Refinement</dd>
            <dt>Status</dt><dd>Closed</dd>
            <dt>Close date</dt><dd>2014-01-13 12:30:18 <a href="http://cb.biplab.in/websvn/log.php?sr=9573"><span class="glyphicon glyphicon-link"></span></a></dd>
            <dt>Assigned to</dt><dd>mortenmacfly</dd>
          </dl>
        </div>
      </div>
      <div class="highlight"><pre class="pre-scrollable"><span class="gh">Index: src/plugins/codecompletion/nativeparser.cpp</span>
<span class="gh">===================================================================</span>
<span class="gd">--- src/plugins/codecompletion/nativeparser.cpp    (revision 9271)</span>
<span class="gi">+++ src/plugins/codecompletion/nativeparser.cpp    (working copy)</span>
<span class="gu">@@ -2166,13 +2166,71 @@</span>
         static bool reentry = false;
         if (reentry)
             return false;
<span class="gd">-</span>
<span class="gi">+        </span>
<span class="gi">+        // Check if user set language standard version to use</span>
<span class="gi">+        wxString standard;</span>
<span class="gi">+        </span>
<span class="gi">+        // Global compiler settings are first to search in</span>
<span class="gi">+        const wxArrayString&amp; globalCompilerOptions = compiler-&gt;GetCompilerOptions();</span>
<span class="gi">+        for (wxArrayString::size_type i = 0; i &lt; globalCompilerOptions.Count(); ++i )</span>
<span class="gi">+        {</span>
<span class="gi">+            if (globalCompilerOptions[i].StartsWith(_T(&quot;-std=&quot;)))</span>
<span class="gi">+            {</span>
<span class="gi">+                standard = globalCompilerOptions[i];</span>
<span class="gi">+                CCLogger::Get()-&gt;DebugLog( F(_T(&quot;NativeParser::AddCompilerPredefinedMacrosGCC(): Using language standard found in compiler&#39;s [%s] global options: %s&quot;), compiler-&gt;GetName().wx_str(), standard.wx_str()) );</span>
<span class="gi">+                break;</span>
<span class="gi">+            }</span>
<span class="gi">+        }</span>
<span class="gi">+        </span>
<span class="gi">+        if (standard.IsEmpty() &amp;&amp; project)</span>
<span class="gi">+        {</span>
<span class="gi">+            if (standard.IsEmpty())</span>
<span class="gi">+            {</span>
<span class="gi">+                // Project compiler setting are second</span>
<span class="gi">+                const wxArrayString&amp; projectCompilerOptions = project-&gt;GetCompilerOptions();</span>
<span class="gi">+                for (wxArrayString::size_type i = 0; i &lt; projectCompilerOptions.Count(); ++i)</span>
<span class="gi">+                {</span>
<span class="gi">+                    if (projectCompilerOptions[i].StartsWith(_T(&quot;-std=&quot;)))</span>
<span class="gi">+                    {</span>
<span class="gi">+                        standard = projectCompilerOptions[i];</span>
<span class="gi">+                        CCLogger::Get()-&gt;DebugLog( F(_T(&quot;NativeParser::AddCompilerPredefinedMacrosGCC(): Using language standard found in project&#39;s [%s] compiler options: %s&quot;), project-&gt;GetTitle().wx_str(), standard.wx_str()) );</span>
<span class="gi">+                        break;</span>
<span class="gi">+                    }</span>
<span class="gi">+                }</span>
<span class="gi">+            }</span>
<span class="gi">+            </span>
<span class="gi">+            // And targets are third in row to look for standard</span>
<span class="gi">+            // NOTE: If two targets use different standards, only the one we</span>
<span class="gi">+            //       encounter first (eg. c++98) will be used, and any other</span>
<span class="gi">+            //       disregarded (even if it would be c++1y)</span>
<span class="gi">+            if (standard.IsEmpty())</span>
<span class="gi">+            {</span>
<span class="gi">+                for (int i = 0; i &lt; project-&gt;GetBuildTargetsCount(); ++i)</span>
<span class="gi">+                {</span>
<span class="gi">+                    ProjectBuildTarget* target = project-&gt;GetBuildTarget(i);</span>
<span class="gi">+                    const wxArrayString&amp; targetOptions = target-&gt;GetCompilerOptions();</span>
<span class="gi">+                    for (wxArrayString::size_type j = 0; j &lt; targetOptions.Count(); ++j)</span>
<span class="gi">+                    {</span>
<span class="gi">+                        if (targetOptions[j].StartsWith(_T(&quot;-std=&quot;)))</span>
<span class="gi">+                        {</span>
<span class="gi">+                            standard = targetOptions[j];</span>
<span class="gi">+                            CCLogger::Get()-&gt;DebugLog( F(_T(&quot;NativeParser::AddCompilerPredefinedMacrosGCC(): Using language standard found in target&#39;s [%s] compiler options: %s&quot;), target-&gt;GetTitle().wx_str(), standard.wx_str()) );</span>
<span class="gi">+                            break;</span>
<span class="gi">+                        }</span>
<span class="gi">+                    }</span>
<span class="gi">+                    </span>
<span class="gi">+                    if (!standard.IsEmpty())</span>
<span class="gi">+                        break;</span>
<span class="gi">+                }</span>
<span class="gi">+            }</span>
<span class="gi">+        }</span>
<span class="gi">+        </span>
 #ifdef __WXMSW__
<span class="gd">-        const wxString args(_T(&quot; -E -dM -x c++ nul&quot;));</span>
<span class="gi">+        const wxString args( F(_T(&quot; -E -dM -x c++ %s nul&quot;), standard.wx_str()) );</span>
 #else
<span class="gd">-        const wxString args(_T(&quot; -E -dM -x c++ /dev/null&quot;));</span>
<span class="gi">+        const wxString args( F(_T(&quot; -E -dM -x c++ %s /dev/null&quot;), standard.wx_str()) );</span>
 #endif
<span class="gd">-</span>
<span class="gi">+        </span>
         wxArrayString output;
         reentry = true;
         if ( wxExecute(cpp_compiler + args, output, wxEXEC_SYNC | wxEXEC_NODISABLE) == -1 )
<span class="gu">@@ -2191,39 +2249,9 @@</span>
         for (size_t i = 0; i &lt; output.Count(); ++i)
             gccDefs += output[i] + _T(&quot;\n&quot;);
     }
<span class="gd">-</span>
<span class="gd">-    static const wxString cxx0xOption(_T(&quot;-std=c++0x&quot;));</span>
<span class="gd">-    static const wxString gnu0xOption(_T(&quot;-std=gnu++0x&quot;));</span>
<span class="gd">-    bool useCxx0x = false;</span>
<span class="gd">-    if (project)</span>
<span class="gd">-    {</span>
<span class="gd">-        const wxArrayString&amp; options = project-&gt;GetCompilerOptions();</span>
<span class="gd">-        if (   options.Index(cxx0xOption) != wxNOT_FOUND</span>
<span class="gd">-            || options.Index(gnu0xOption) != wxNOT_FOUND )</span>
<span class="gd">-        {</span>
<span class="gd">-            useCxx0x = true;</span>
<span class="gd">-        }</span>
<span class="gd">-        else</span>
<span class="gd">-        {</span>
<span class="gd">-            for (int i = 0; i &lt; project-&gt;GetBuildTargetsCount(); ++i)</span>
<span class="gd">-            {</span>
<span class="gd">-                ProjectBuildTarget* target = project-&gt;GetBuildTarget(i);</span>
<span class="gd">-                const wxArrayString&amp; targetOptions = target-&gt;GetCompilerOptions();</span>
<span class="gd">-                if (   targetOptions.Index(cxx0xOption) != wxNOT_FOUND</span>
<span class="gd">-                    || targetOptions.Index(gnu0xOption) != wxNOT_FOUND )</span>
<span class="gd">-                {</span>
<span class="gd">-                    useCxx0x = true;</span>
<span class="gd">-                    break;</span>
<span class="gd">-                }</span>
<span class="gd">-            }</span>
<span class="gd">-        }</span>
<span class="gd">-    }</span>
<span class="gd">-</span>
<span class="gd">-    if (useCxx0x)</span>
<span class="gd">-        defs = gccDefsMap[cpp_compiler] + _T(&quot;#define __GXX_EXPERIMENTAL_CXX0X__ 1\n&quot;);</span>
<span class="gd">-    else</span>
<span class="gd">-        defs = gccDefsMap[cpp_compiler];</span>
<span class="gd">-</span>
<span class="gi">+    </span>
<span class="gi">+    defs = gccDefsMap[cpp_compiler];</span>
<span class="gi">+    </span>
     return true;
 }
 
</pre></div>

      <h4 class="page-header">History</h4>
      <div class="panel panel-default">
        <div class="panel-heading">enter_cze 2013-08-24 19:58:43</div>
        <div class="panel-body">
          <p>If user has set language standard version (eg. -std=c++11, -std=c++98 or even -std=c11), it will be used when asking GCC compiler for built-in defines.</p>
          <p>__cplusplus, __GXX_EXPERIMENTAL_CXX0X__ or other standard specific defines will be set accordingly, so parser can now look inside #if __cplusplus &gt; 199711L and register std::shared_ptr and other C++11 features in newest compiler versions which doesn't use __GXX_EXPERIMENTAL_CXX0X__ anymore.</p>
          <p>Lookup is done in order - first global compiler options, if not found then project compiler options, if not found then all the targets. If not found, no standard will be used in the query to compiler, returning the default defines (__cplusplus 199711L atm)</p>
          <p>Note: Targets are searched with for(;;), so first found standard is first served - if first target has -std=c++98 and second has -std=c++11, the first is encountered first and sent to compiler in query.</p>
          <p>Language is always set as c++, even if You might want to use C. However You can set standard -std=c98, -std=c11 or other anyway - it will work (GCC emits warning on stderr) and it returns some (but not all) defines used in C.</p>
        </div>
      </div>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
  </body>
</html>