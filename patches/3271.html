<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Patch 3271 - Code::Blocks History</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">

    <link rel="stylesheet" href="../pygments.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body role="document">
    <div class="navbar navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://www.codeblocks.org/">Code::Blocks</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../index.html">Home</a></li>
            <li><a href="../bugs.html">Bugs</a></li>
            <li><a href="../features.html">Features</a></li>
            <li class="active"><a href="../patches.html">Patches</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container" role="main">
      <div class="row">
        <div class="col-sm-8">
          <h3>Patch #3271 <small>2012-04-03 20:58</small></h3>
          <h4>sbezgodov</h4>
          Select any project or entire workspace to get statistics
          <dl class="dl-horizontal">
            <dt>Download</dt>
            <dd><a href="3271-Select_any_pro.patch">3271-Select_any_pro.patch</a> (38.9 KB)</dd>
          </dl>
        </div>
        <div class="col-sm-4">
          <dl class="dl-horizontal">
            <dt>Category</dt><dd>Plugin::FeatureAdd</dd>
            <dt>Status</dt><dd>Accepted</dd>
            <dt>Close date</dt><dd>2012-07-07 11:55 <a href="http://cb.biplab.in/websvn/log.php?sr=8094"><span class="glyphicon glyphicon-link"></span></a></dd>
            <dt>Assigned to</dt><dd>tpetrov</dd>
          </dl>
        </div>
      </div>
      <div class="highlight"><pre class="pre-scrollable"><span class="gh">Index: codestatexec.h</span>
<span class="gh">===================================================================</span>
<span class="gd">--- codestatexec.h    (revision 8065)</span>
<span class="gi">+++ codestatexec.h    (working copy)</span>
<span class="gu">@@ -15,23 +15,39 @@</span>
 #include &quot;language_def.h&quot;
 
 class wxWindow;
<span class="gi">+class wxProgressDialog;</span>
 
 /** This class computes the statistics of the project&#39;s files and display them.
  *  @see CodeStat, CodeStatConfigDlg, CodeStatExecDlg, LanguageDef
  */
<span class="gi">+</span>
<span class="gi">+class CodeStatCache;</span>
<span class="gi">+</span>
 class CodeStatExecDlg : public wxScrollingDialog
 {
<span class="gd">-    public:</span>
<span class="gd">-        CodeStatExecDlg(wxWindow* parent) : parent(parent){}</span>
<span class="gd">-        virtual ~CodeStatExecDlg();</span>
<span class="gd">-        int Execute(LanguageDef languages[NB_FILETYPES_MAX], int nb_languages);</span>
<span class="gd">-    private:</span>
<span class="gd">-      void EndModal(int retCode);</span>
<span class="gd">-      void CountLines(wxFileName filename, LanguageDef &amp;language,</span>
<span class="gd">-                      long int &amp;code_lines, long int &amp;codecomments_lines,</span>
<span class="gd">-                      long int &amp;comment_lines, long int &amp;empty_lines, long int &amp;total_lines);</span>
<span class="gd">-      void AnalyseLine(LanguageDef &amp;language, wxString line, bool &amp;comment, bool &amp;code, bool &amp;multi_line_comment);</span>
<span class="gd">-      wxWindow* parent;</span>
<span class="gi">+public:</span>
<span class="gi">+    CodeStatExecDlg(wxWindow* parent);</span>
<span class="gi">+    virtual ~CodeStatExecDlg();</span>
<span class="gi">+    int Execute(LanguageDef languages[NB_FILETYPES_MAX], int nb_languages);</span>
<span class="gi">+private:</span>
<span class="gi">+    void EndModal(int retCode);</span>
<span class="gi">+    void OnSelectProject(wxCommandEvent&amp; evt);</span>
<span class="gi">+    void OnIdle(wxIdleEvent&amp; evt);</span>
<span class="gi">+    void ParseProject(int index);</span>
<span class="gi">+    void DoParseProject(int index);</span>
<span class="gi">+    void DoParseWorkspace();</span>
<span class="gi">+    void UpdateProgress();</span>
<span class="gi">+    void ShowResults(int index);</span>
<span class="gi">+</span>
<span class="gi">+    wxWindow* m_parent;</span>
<span class="gi">+    wxChoice* m_choice;</span>
<span class="gi">+    wxProgressDialog* m_progress;</span>
<span class="gi">+    CodeStatCache* m_cache;</span>
<span class="gi">+    LanguageDef* m_languages;</span>
<span class="gi">+    int m_nb_languages;</span>
<span class="gi">+    int m_nb_files;</span>
<span class="gi">+    int m_current_file;</span>
<span class="gi">+    bool m_changed;</span>
 };
 
 #endif // CODESTATEXEC_H
<span class="gh">Index: resources/main_dialog.xrc</span>
<span class="gh">===================================================================</span>
<span class="gd">--- resources/main_dialog.xrc    (revision 8065)</span>
<span class="gi">+++ resources/main_dialog.xrc    (working copy)</span>
<span class="gu">@@ -1,199 +1,232 @@</span>
 &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;
<span class="gd">-&lt;resource xmlns=&quot;http://www.wxwidgets.org/wxxrc&quot;&gt;</span>
<span class="gd">-  &lt;object class=&quot;wxScrollingDialog&quot; name=&quot;dlgCodeStatExec&quot;&gt;</span>
<span class="gd">-    &lt;title&gt;Code Statistics&lt;/title&gt;</span>
<span class="gd">-    &lt;object class=&quot;wxBoxSizer&quot;&gt;</span>
<span class="gd">-      &lt;orient&gt;wxVERTICAL&lt;/orient&gt;</span>
<span class="gd">-      &lt;object class=&quot;sizeritem&quot;&gt;</span>
<span class="gd">-        &lt;object class=&quot;wxStaticBoxSizer&quot;&gt;</span>
<span class="gd">-          &lt;orient&gt;wxVERTICAL&lt;/orient&gt;</span>
<span class="gd">-          &lt;object class=&quot;sizeritem&quot;&gt;</span>
<span class="gd">-            &lt;object class=&quot;wxGridSizer&quot;&gt;</span>
<span class="gd">-              &lt;cols&gt;2&lt;/cols&gt;</span>
<span class="gd">-              &lt;rows&gt;2&lt;/rows&gt;</span>
<span class="gd">-              &lt;object class=&quot;sizeritem&quot;&gt;</span>
<span class="gd">-                &lt;object class=&quot;wxStaticText&quot;&gt;</span>
<span class="gd">-                  &lt;label&gt;Number of files:&lt;/label&gt;</span>
<span class="gd">-                &lt;/object&gt;</span>
<span class="gd">-              &lt;/object&gt;</span>
<span class="gd">-              &lt;object class=&quot;sizeritem&quot;&gt;</span>
<span class="gd">-                &lt;object class=&quot;wxStaticText&quot; name=&quot;txt_num_files&quot;&gt;</span>
<span class="gd">-                  &lt;label&gt;999999&lt;/label&gt;</span>
<span class="gd">-                  &lt;style&gt;wxALIGN_RIGHT&lt;/style&gt;</span>
<span class="gd">-                &lt;/object&gt;</span>
<span class="gd">-                &lt;flag&gt;wxALIGN_RIGHT&lt;/flag&gt;</span>
<span class="gd">-              &lt;/object&gt;</span>
<span class="gd">-              &lt;object class=&quot;sizeritem&quot;&gt;</span>
<span class="gd">-                &lt;object class=&quot;wxStaticText&quot;&gt;</span>
<span class="gd">-                  &lt;label&gt;Files skipped:&lt;/label&gt;</span>
<span class="gd">-                &lt;/object&gt;</span>
<span class="gd">-              &lt;/object&gt;</span>
<span class="gd">-              &lt;object class=&quot;sizeritem&quot;&gt;</span>
<span class="gd">-                &lt;object class=&quot;wxStaticText&quot; name=&quot;txt_skipped_files&quot;&gt;</span>
<span class="gd">-                  &lt;label&gt;999999&lt;/label&gt;</span>
<span class="gd">-                  &lt;style&gt;wxALIGN_RIGHT&lt;/style&gt;</span>
<span class="gd">-                &lt;/object&gt;</span>
<span class="gd">-                &lt;flag&gt;wxALIGN_RIGHT&lt;/flag&gt;</span>
<span class="gd">-              &lt;/object&gt;</span>
<span class="gd">-              &lt;object class=&quot;sizeritem&quot;&gt;</span>
<span class="gd">-                &lt;object class=&quot;wxStaticText&quot;&gt;</span>
<span class="gd">-                  &lt;label&gt;Files not found:&lt;/label&gt;</span>
<span class="gd">-                &lt;/object&gt;</span>
<span class="gd">-              &lt;/object&gt;</span>
<span class="gd">-              &lt;object class=&quot;sizeritem&quot;&gt;</span>
<span class="gd">-                &lt;object class=&quot;wxStaticText&quot; name=&quot;txt_files_not_found&quot;&gt;</span>
<span class="gd">-                  &lt;label&gt;999999&lt;/label&gt;</span>
<span class="gd">-                  &lt;style&gt;wxALIGN_RIGHT&lt;/style&gt;</span>
<span class="gd">-                &lt;/object&gt;</span>
<span class="gd">-                &lt;flag&gt;wxALIGN_RIGHT&lt;/flag&gt;</span>
<span class="gd">-              &lt;/object&gt;</span>
<span class="gd">-            &lt;/object&gt;</span>
<span class="gd">-            &lt;flag&gt;wxALL|wxEXPAND&lt;/flag&gt;</span>
<span class="gd">-            &lt;border&gt;5&lt;/border&gt;</span>
<span class="gd">-          &lt;/object&gt;</span>
<span class="gd">-          &lt;object class=&quot;sizeritem&quot;&gt;</span>
<span class="gd">-            &lt;object class=&quot;wxGridSizer&quot;&gt;</span>
<span class="gd">-              &lt;cols&gt;2&lt;/cols&gt;</span>
<span class="gd">-              &lt;rows&gt;2&lt;/rows&gt;</span>
<span class="gd">-              &lt;object class=&quot;sizeritem&quot;&gt;</span>
<span class="gd">-                &lt;object class=&quot;wxGauge&quot; name=&quot;Gauge_Code&quot;&gt;</span>
<span class="gd">-                  &lt;range&gt;100&lt;/range&gt;</span>
<span class="gd">-                  &lt;size&gt;-1,20&lt;/size&gt;</span>
<span class="gd">-                &lt;/object&gt;</span>
<span class="gd">-                &lt;flag&gt;wxALL|wxEXPAND&lt;/flag&gt;</span>
<span class="gd">-                &lt;border&gt;2&lt;/border&gt;</span>
<span class="gd">-              &lt;/object&gt;</span>
<span class="gd">-              &lt;object class=&quot;sizeritem&quot;&gt;</span>
<span class="gd">-                &lt;object class=&quot;wxStaticText&quot; name=&quot;txt_Gauge_Code&quot;&gt;</span>
<span class="gd">-                  &lt;label&gt;XXXX% Code only&lt;/label&gt;</span>
<span class="gd">-                &lt;/object&gt;</span>
<span class="gd">-                &lt;flag&gt;wxALIGN_CENTRE_VERTICAL&lt;/flag&gt;</span>
<span class="gd">-              &lt;/object&gt;</span>
<span class="gd">-              &lt;object class=&quot;sizeritem&quot;&gt;</span>
<span class="gd">-                &lt;object class=&quot;wxGauge&quot; name=&quot;Gauge_Code_Comments&quot;&gt;</span>
<span class="gd">-                  &lt;ra</span>
<em><strong>file truncated...</strong></em>
</pre></div>

      <h4 class="page-header">History</h4>
      <div class="panel panel-default">
        <div class="panel-heading">sbezgodov 2012-04-03 21:00</div>
        <div class="panel-body">
          <p>This is CodeStat plugin upgrade.</p>
          <p>Just apply the patch. No any sources, configs or images are added.</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">tpetrov 2012-06-07 19:22</div>
        <div class="panel-body">
          <p>I'll try this patch and if there are no problem will commit it.</p>
          <p>Thank you for the contribution.</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">tpetrov 2012-06-07 19:32</div>
        <div class="panel-body">
          <pre class="pre-scrollable">Hm, I get an immediate crash, when switching to "Entire workspace".
The crash happens, because OnIdle is called twice and m_changed=true, both time.

I'm running latest revision of C::B on linux and here is the callstack:

#0 0x7fffe0cc21a3	CodeStatExecDlg::DoParseWorkspace(this=0x1a2dd80) (/home/obfuscated/projects/codeblocks/git/src/plugins/contrib/codestat/codestatexec.cpp:251)
#1 0x7fffe0cc1b34	CodeStatExecDlg::OnIdle(this=0x1a2dd80, evt=@0x7fffffffb000: &lt;incomplete type&gt;) (/home/obfuscated/projects/codeblocks/git/src/plugins/contrib/codestat/codestatexec.cpp:174)
#2 0x7ffff4209e56	wxEvtHandler::ProcessEventIfMatches(wxEventTableEntryBase const&amp;, wxEvtHandler*, wxEvent&amp;)() (/usr/lib64/libwx_baseu-2.8.so.0:??)
#3 0x7ffff420a23f	wxEvtHandler::SearchDynamicEventTable(wxEvent&amp;)() (/usr/lib64/libwx_baseu-2.8.so.0:??)
#4 0x7ffff420a2f2	wxEvtHandler::ProcessEvent(wxEvent&amp;)() (/usr/lib64/libwx_baseu-2.8.so.0:??)
#5 0x7ffff4908e64	wxAppBase::SendIdleEvents(wxWindow*, wxIdleEvent&amp;)() (/usr/lib64/libwx_gtk2u_core-2.8.so.0:??)
#6 0x7ffff4908e34	wxAppBase::SendIdleEvents(wxWindow*, wxIdleEvent&amp;)() (/usr/lib64/libwx_gtk2u_core-2.8.so.0:??)
#7 0x7ffff4909365	wxAppBase::ProcessIdle()() (/usr/lib64/libwx_gtk2u_core-2.8.so.0:??)
#8 0x7ffff4881f4e	??() (/usr/lib64/libwx_gtk2u_core-2.8.so.0:??)
#9 0x7ffff59a6542	g_main_context_dispatch() (/usr/lib64/libglib-2.0.so.0:??)
#10 0x7ffff59a6888	??() (/usr/lib64/libglib-2.0.so.0:??)
#11 0x7ffff59a6944	g_main_context_iteration() (/usr/lib64/libglib-2.0.so.0:??)
#12 0x7ffff78da2b1	gtk_main_iteration() (/usr/lib64/libgtk-x11-2.0.so.0:??)
#13 0x7ffff4882a95	wxApp::Yield(bool)() (/usr/lib64/libwx_gtk2u_core-2.8.so.0:??)
#14 0x7ffff49a0309	wxProgressDialog::DoAfterUpdate(bool*)() (/usr/lib64/libwx_gtk2u_core-2.8.so.0:??)
#15 0x7ffff49a0913	wxProgressDialog::Update(int, wxString const&amp;, bool*)() (/usr/lib64/libwx_gtk2u_core-2.8.so.0:??)
#16 0x7fffe0cc262e	CodeStatExecDlg::UpdateProgress(this=0x1a2dd80) (/home/obfuscated/projects/codeblocks/git/src/plugins/contrib/codestat/codestatexec.cpp:291)
#17 0x7fffe0cc1e68	CodeStatExecDlg::ParseProject(this=0x1a2dd80, index=3) (/home/obfuscated/projects/codeblocks/git/src/plugins/contrib/codestat/codestatexec.cpp:223)
#18 0x7fffe0cc2349	CodeStatExecDlg::DoParseWorkspace(this=0x1a2dd80) (/home/obfuscated/projects/codeblocks/git/src/plugins/contrib/codestat/codestatexec.cpp:266)
#19 0x7fffe0cc1b34	CodeStatExecDlg::OnIdle(this=0x1a2dd80, evt=@0x7fffffffb540: &lt;incomplete type&gt;) (/home/obfuscated/projects/codeblocks/git/src/plugins/contrib/codestat/codestatexec.cpp:174)
#20 0x7ffff4209e56	wxEvtHandler::ProcessEventIfMatches(wxEventTableEntryBase const&amp;, wxEvtHandler*, wxEvent&amp;)() (/usr/lib64/libwx_baseu-2.8.so.0:??)
#21 0x7ffff420a23f	wxEvtHandler::SearchDynamicEventTable(wxEvent&amp;)() (/usr/lib64/libwx_baseu-2.8.so.0:??)
#22 0x7ffff420a2f2	wxEvtHandler::ProcessEvent(wxEvent&amp;)() (/usr/lib64/libwx_baseu-2.8.so.0:??)
#23 0x7ffff4908e64	wxAppBase::SendIdleEvents(wxWindow*, wxIdleEvent&amp;)() (/usr/lib64/libwx_gtk2u_core-2.8.so.0:??)
#24 0x7ffff4908e34	wxAppBase::SendIdleEvents(wxWindow*, wxIdleEvent&amp;)() (/usr/lib64/libwx_gtk2u_core-2.8.so.0:??)
#25 0x7ffff4909365	wxAppBase::ProcessIdle()() (/usr/lib64/libwx_gtk2u_core-2.8.so.0:??)
#26 0x7ffff4881f4e	??() (/usr/lib64/libwx_gtk2u_core-2.8.so.0:??)
#27 0x7ffff59a6542	g_main_context_dispatch() (/usr/lib64/libglib-2.0.so.0:??)
#28 0x7ffff59a6888	??() (/usr/lib64/libglib-2.0.so.0:??)
#29 0x7ffff59a6c7a	g_main_loop_run() (/usr/lib64/libglib-2.0.so.0:??)
#30 0x7ffff78da0a7	gtk_main() (/usr/lib64/libgtk-x11-2.0.so.0:??)

See how DoParseWorkspace is called twice? I guess moving the m_change=false just after the check if (!m_changed) will fix it.
Can you give it a try and post fixed patch?</pre>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">sbezgodov 2012-06-22 13:31</div>
        <div class="panel-body">
          <p>Hello, I have moved m_changed=false right after check (!m_changed). Now plugin works fine. Tested under linux 32-bit.</p>
          <p>Patch is created against trunk 8065 revision.</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">tpetrov 2012-07-07 11:55</div>
        <div class="panel-body">
          <p>OK, I've committed your patch. I've made some modifications to make the code a bit clearer and to conform to the cb-style-guide.</p>
          <p>Also I've fixed one bug introduced with your patch... see the svn log for details.</p>
          <p>Thank you for the contribution.</p>
          <p>Now I have to find some time to design a better interface for this plugin.</p>
          <p>Have you tought of replacing the current UI with a list ctrl and putting all stats in one page - one line per project and a summary at the bottom?</p>
          <p>And would you like to do it as I don't have much time at the moment?</p>
        </div>
      </div>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
  </body>
</html>