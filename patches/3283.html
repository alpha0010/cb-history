<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Patch 3283 - Code::Blocks History</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">

    <link rel="stylesheet" href="../pygments.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body role="document">
    <div class="navbar navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://www.codeblocks.org/">Code::Blocks</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../index.html">Home</a></li>
            <li><a href="../bugs.html">Bugs</a></li>
            <li><a href="../features.html">Features</a></li>
            <li class="active"><a href="../patches.html">Patches</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container" role="main">
      <div class="row">
        <div class="col-sm-8">
          <h3>Patch #3283 <small>2012-04-28 02:57:58</small></h3>
          <h4>alpha0010</h4>
          Context menu: Open link in browser
          <dl class="dl-horizontal">
            <dt>Download</dt>
            <dd><a href="3283-Context_menu_O.patch">3283-Context_menu_O.patch</a></dd>
          </dl>
        </div>
        <div class="col-sm-4">
          <dl class="dl-horizontal">
            <dt>Category</dt><dd>Application::FeatureAdd</dd>
            <dt>Status</dt><dd>Accepted</dd>
            <dt>Close date</dt><dd>2012-06-17 07:52:47</dd>
            <dt>Assigned to</dt><dd>ollydbg</dd>
          </dl>
        </div>
      </div>
      <div class="highlight"><pre class="pre-scrollable"><span class="gh">Index: src/sdk/cbeditor.cpp</span>
<span class="gh">===================================================================</span>
<span class="gd">--- src/sdk/cbeditor.cpp    (revision 8021)</span>
<span class="gi">+++ src/sdk/cbeditor.cpp    (working copy)</span>
<span class="gu">@@ -552,6 +552,66 @@</span>
         }
     }
 
<span class="gi">+    wxString GetUrl()</span>
<span class="gi">+    {</span>
<span class="gi">+        cbStyledTextCtrl* control = m_pOwner-&gt;GetControl();</span>
<span class="gi">+        if (!control)</span>
<span class="gi">+            return wxEmptyString;</span>
<span class="gi">+</span>
<span class="gi">+        wxRegEx reUrl(wxT(&quot;***:(((ht|f)tp(s?)\\:\\/\\/)|(www\\.))(([a-zA-Z0-9\\-\\._]+(\\.[a-zA-Z0-9\\-\\._]+)+)|localhost)(\\/?)([a-zA-Z0-9\\-\\.\\?\\,\\&#39;\\/\\\\\\+&amp;amp;%\\$#_]*)?([\\d\\w\\.\\/\\%\\+\\-\\=\\&amp;amp;\\?\\:\\\\\\&amp;quot;\\&#39;\\,\\|\\~\\;]*)&quot;));</span>
<span class="gi">+        wxString url = control-&gt;GetSelectedText();</span>
<span class="gi">+        // Is the URL selected?</span>
<span class="gi">+        if (reUrl.Matches(url))</span>
<span class="gi">+            return reUrl.GetMatch(url);</span>
<span class="gi">+        // else is there a URL near the cursor?</span>
<span class="gi">+</span>
<span class="gi">+        // Find out start position</span>
<span class="gi">+        int startPos = control-&gt;GetCurrentPos();</span>
<span class="gi">+        const wxString space = wxT(&quot; \n\r\t{}&quot;);</span>
<span class="gi">+        wxChar curCh = control-&gt;GetCharAt(startPos);</span>
<span class="gi">+        while ( (startPos &gt; 0) &amp;&amp; (space.Find(curCh) == -1) )</span>
<span class="gi">+        {</span>
<span class="gi">+            startPos--;</span>
<span class="gi">+            curCh = control-&gt;GetCharAt(startPos);</span>
<span class="gi">+        }</span>
<span class="gi">+</span>
<span class="gi">+        // Find out end position</span>
<span class="gi">+        int endPos = control-&gt;GetCurrentPos();</span>
<span class="gi">+        int maxPos = control-&gt;GetLineEndPosition(control-&gt;GetLineCount());</span>
<span class="gi">+        curCh = control-&gt;GetCharAt(endPos);</span>
<span class="gi">+        while ( (endPos &lt; maxPos) &amp;&amp; (space.Find(curCh) == -1) )</span>
<span class="gi">+        {</span>
<span class="gi">+            endPos++;</span>
<span class="gi">+            curCh = control-&gt;GetCharAt(endPos);</span>
<span class="gi">+        }</span>
<span class="gi">+</span>
<span class="gi">+        url = control-&gt;GetTextRange(startPos, endPos);</span>
<span class="gi">+        if ( (control-&gt;GetLexer() == wxSCI_LEX_CPP)</span>
<span class="gi">+                &amp;&amp; ( (control-&gt;GetStyleAt(control-&gt;GetCurrentPos()) == wxSCI_C_STRING)</span>
<span class="gi">+                     || (control-&gt;GetStyleAt(control-&gt;GetCurrentPos()) == wxSCI_C_STRINGEOL) ) )</span>
<span class="gi">+        {</span>
<span class="gi">+            url.Replace(wxT(&quot;\\n&quot;), wxT(&quot;\n&quot;));</span>
<span class="gi">+            url.Replace(wxT(&quot;\\r&quot;), wxT(&quot;\r&quot;));</span>
<span class="gi">+            url.Replace(wxT(&quot;\\t&quot;), wxT(&quot;\t&quot;));</span>
<span class="gi">+        }</span>
<span class="gi">+</span>
<span class="gi">+        if (reUrl.Matches(url))</span>
<span class="gi">+        {</span>
<span class="gi">+            wxString match = reUrl.GetMatch(url);</span>
<span class="gi">+            if ( (url.Find(match) + startPos &lt; control-&gt;GetCurrentPos())</span>
<span class="gi">+                    &amp;&amp; (url.Find(match) + startPos + (int)match.Length() &gt; control-&gt;GetCurrentPos()) )</span>
<span class="gi">+            {</span>
<span class="gi">+                url = match;</span>
<span class="gi">+            }</span>
<span class="gi">+            else</span>
<span class="gi">+                url = wxEmptyString; // nope, too far from cursor, return invalid (empty)</span>
<span class="gi">+        }</span>
<span class="gi">+        else</span>
<span class="gi">+            url = wxEmptyString; // nope, return invalid (empty)</span>
<span class="gi">+</span>
<span class="gi">+        return url;</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
     //vars
     bool m_strip_trailing_spaces;
     bool m_ensure_final_line_end;
<span class="gu">@@ -609,6 +669,7 @@</span>
 const int idAddFileToProject = wxNewId();
 const int idRemoveFileFromProject = wxNewId();
 const int idShowFileInProject = wxNewId();
<span class="gi">+const int idOpenUrl = wxNewId();</span>
 
 const int idBookmarkAdd = wxNewId();
 const int idBookmarkRemove = wxNewId();
<span class="gu">@@ -661,6 +722,7 @@</span>
     EVT_MENU(idSplitHorz, cbEditor::OnContextMenuEntry)
     EVT_MENU(idSplitVert, cbEditor::OnContextMenuEntry)
     EVT_MENU(idUnsplit, cbEditor::OnContextMenuEntry)
<span class="gi">+    EVT_MENU(idOpenUrl, cbEditor::OnContextMenuEntry)</span>
 
     EVT_SCI_ZOOM(-1, cbEditor::OnZoom)
     EVT_SCI_ZOOM(-1, cbEditor::OnZoom)
<span class="gu">@@ -2673,6 +2735,12 @@</span>
     }
     else
     {
<span class="gi">+        if(!noeditor &amp;&amp; !m_pData-&gt;GetUrl().IsEmpty())</span>
<span class="gi">+        {</span>
<span class="gi">+            popup-&gt;InsertSeparator(0);</span>
<span class="gi">+            popup-&gt;Insert(0, idOpenUrl, _(&quot;Open link in browser&quot;));</span>
<span class="gi">+        }</span>
<span class="gi">+</span>
         wxMenu* splitMenu = new wxMenu;
         splitMenu-&gt;Append(idSplitHorz, _(&quot;Horizontally&quot;));
         splitMenu-&gt;Append(idSplitVert, _(&quot;Vertically&quot;));
<span class="gu">@@ -2933,6 +3001,8 @@</span>
         UnfoldBlockFromLine();
     else if (id == idFoldingToggleCurrent)
         ToggleFoldBlockFromLine();
<span class="gi">+    else if (id == idOpenUrl)</span>
<span class="gi">+        wxLaunchDefaultBrowser(m_pData-&gt;GetUrl());</span>
     else if (id == idSplitHorz)
         Split(stHorizontal);
     else if (id == idSplitVert)
</pre></div>

      <h4 class="page-header">History</h4>
      <div class="panel panel-default">
        <div class="panel-heading">ollydbg 2012-04-28 07:59:47</div>
        <div class="panel-body">
          <p>Very nice feature, I would like to apply in the near future.</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">alpha0010 2012-05-26 20:11:28</div>
        <div class="panel-body">
          <p>Improve detection accuracy on escape sequences in strings.</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">mortenmacfly 2012-05-27 08:40:18</div>
        <div class="panel-body">
          <p>Agreed from my side. Its like in Eclipse or other editors...</p>
          <p>Just do a tiny clean-up of the code, for example: if you checked that url.IsEmpty() you don't need the last else- clause where you set url to "empty" explicitly again...</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">mortenmacfly 2012-05-27 09:03:36</div>
        <div class="panel-body">
          <pre class="pre-scrollable">Another one: It does not compile under wxWidgets 2.9.x.

I've an updated function here, that works (and is cleaned-up):

    wxString GetUrl()
    {
        cbStyledTextCtrl* control = m_pOwner-&gt;GetControl();
        if (!control)
            return wxEmptyString;

        wxRegEx reUrl(wxT("***:(((ht|f)tp(s?)\\:\\/\\/)|(www\\.))(([a-zA-Z0-9\\-\\._]+(\\.[a-zA-Z0-9\\-\\._]+)+)|localhost)(\\/?)([a-zA-Z0-9\\-\\.\\?\\,\\'\\/\\\\\\+&amp;amp;%\\$#_]*)?([\\d\\w\\.\\/\\%\\+\\-\\=\\&amp;amp;\\?\\:\\\\\\&amp;quot;\\'\\,\\|\\~\\;]*)"));
        wxString url = control-&gt;GetSelectedText(); url.Trim(true).Trim(false);
        if (url.IsEmpty())
            return wxEmptyString;
        if (reUrl.Matches(url))
            return reUrl.GetMatch(url);

        // Find out start position
        int startPos = control-&gt;GetCurrentPos();
        const wxString space = wxT(" \n\r\t{}");
        wxChar startCh = control-&gt;GetCharAt(startPos);
        while ( (startPos &gt; 0) &amp;&amp; (space.Find(startCh) == -1) )
            startPos--;

        // Find out end position
        int endPos = control-&gt;GetCurrentPos();
        int maxPos = control-&gt;GetLineEndPosition(control-&gt;GetLineCount());
        wxChar endCh = control-&gt;GetCharAt(endPos);
        while ( (endPos &lt; maxPos) &amp;&amp; (space.Find(endCh) == -1) )
            endPos++;

        url = control-&gt;GetTextRange(startPos, endPos);
        if (    (control-&gt;GetLexer() == wxSCI_LEX_CPP)
            &amp;&amp;  (   (control-&gt;GetStyleAt(control-&gt;GetCurrentPos()) == wxSCI_C_STRING)
                 || (control-&gt;GetStyleAt(control-&gt;GetCurrentPos()) == wxSCI_C_STRINGEOL) ) )
        {
            url.Replace(wxT("\\n"), wxT("\n"));
            url.Replace(wxT("\\r"), wxT("\r"));
            url.Replace(wxT("\\t"), wxT("\t"));
        }

        if (reUrl.Matches(url))
        {
            wxString match = reUrl.GetMatch(url);
            if (   (url.Find(match) + startPos                       &lt; control-&gt;GetCurrentPos())
                &amp;&amp; (url.Find(match) + startPos + (int)match.Length() &gt; control-&gt;GetCurrentPos()) )
            {
                url = match;
            }
            else
                url = wxEmptyString; // nope, return invalid (empty)
        }
        else
            url = wxEmptyString; // nope, return invalid (empty)

        return url;
    }
</pre>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">alpha0010 2012-05-27 22:03:56</div>
        <div class="panel-body">
          <p>Updated to the cleaned-up function with the following modifications:</p>
          <p>* removed Trim() - had no purpose</p>
          <p>* removed several optimizations - these caused it to only work if the URL was already selected (GetUrl() first checks if a URL is selected, then checks if there is a URL near the cursor - so one can simply right-click on a link, without needing to actually select it)</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">mortenmacfly 2012-06-01 16:00:10</div>
        <div class="panel-body">
          <pre class="pre-scrollable">This part:

        while ( (startPos &gt; 0) &amp;&amp; (space.Find(control-&gt;GetCharAt(startPos)) == -1) )

does NOT work with wx2.9.x. I changed that on purpose to:

        wxChar startCh = control-&gt;GetCharAt(startPos);
        while ( (startPos &gt; 0) &amp;&amp; (space.Find(startCh) == -1) )
            startPos--;

...(at two positions) in my other comment. Please leave it like that.</pre>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">alpha0010 2012-06-01 21:11:39</div>
        <div class="panel-body">
          <p>Apologies; I had reverted that because it broke the range finding logic (wxChar must update each iteration).</p>
          <p>Does this revision compile with wx2.9.x?</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">mortenmacfly 2012-06-16 07:33:24</div>
        <div class="panel-body">
          <p>Ok, this one is fine.</p>
          <p>@ollydbg: Should I commit / will you? (I have it aligned a little bit more, but the content is the same and working in this version.)</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">ollydbg 2012-06-17 01:46:39</div>
        <div class="panel-body">
          <p>@morten: please commit it.</p>
          <p>PS: I see there are some parenthesis in "if" or "while" condition which can be removed, right?</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">mortenmacfly 2012-06-17 07:52:47</div>
        <div class="panel-body">
          <p>Applied in SVN head (on behalf of ollydbg). Thanks!</p>
        </div>
      </div>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
  </body>
</html>