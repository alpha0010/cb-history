<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Patch 3118 - Code::Blocks History</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">

    <link rel="stylesheet" href="../pygments.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body role="document">
    <div class="navbar navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://www.codeblocks.org/">Code::Blocks</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../index.html">Home</a></li>
            <li><a href="../bugs.html">Bugs</a></li>
            <li><a href="../features.html">Features</a></li>
            <li class="active"><a href="../patches.html">Patches</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container" role="main">
      <div class="row">
        <div class="col-sm-8">
          <h3>Patch #3118 <small>2011-01-16 04:33</small></h3>
          <h4>etheranger</h4>
          Multiple bugfixes for CDB driver
          <dl class="dl-horizontal">
            <dt>Download</dt>
            <dd><a href="3118-Multiple_bugfi.patch">3118-Multiple_bugfi.patch</a> (8.7 KB)</dd>
          </dl>
        </div>
        <div class="col-sm-4">
          <dl class="dl-horizontal">
            <dt>Category</dt><dd>Application::Bugfix</dd>
            <dt>Status</dt><dd>Out of date</dd>
            <dt>Close date</dt><dd>2011-02-03 20:02</dd>
            <dt>Assigned to</dt><dd>mortenmacfly</dd>
          </dl>
        </div>
      </div>
      <div class="highlight"><pre class="pre-scrollable"><span class="gh">Index: src/plugins/debuggergdb/cdb_commands.h</span>
<span class="gh">===================================================================</span>
<span class="gd">--- src/plugins/debuggergdb/cdb_commands.h    (revision 6930)</span>
<span class="gi">+++ src/plugins/debuggergdb/cdb_commands.h    (working copy)</span>
<span class="gu">@@ -16,6 +16,7 @@</span>
 #include &quot;debuggertree.h&quot;
 #include &quot;backtracedlg.h&quot;
 
<span class="gi">+static wxRegEx reProcessInf(_T(&quot;id:[ \t]+([A-Fa-f0-9]+)[ \t]+create&quot;));</span>
 static wxRegEx reWatch(_T(&quot;(\\+0x[A-Fa-f0-9]+ )&quot;));
 static wxRegEx reBT1(_T(&quot;([0-9]+) ([A-Fa-f0-9]+) ([A-Fa-f0-9]+) ([^[]*)&quot;));
 static wxRegEx reBT2(_T(&quot;\\[([A-z]:)(.*) @ ([0-9]+)\\]&quot;));
<span class="gu">@@ -174,6 +175,40 @@</span>
 };
 
 /**
<span class="gi">+  * Command to find the PID of the active child</span>
<span class="gi">+  */</span>
<span class="gi">+  class CdbCmd_GetPID : public DebuggerCmd</span>
<span class="gi">+{</span>
<span class="gi">+    public:</span>
<span class="gi">+        /** @param file The file to debug. */</span>
<span class="gi">+        CdbCmd_GetPID(DebuggerDriver* driver)</span>
<span class="gi">+            : DebuggerCmd(driver)</span>
<span class="gi">+        {</span>
<span class="gi">+            m_Cmd &lt;&lt; _T(&quot;|.&quot;);</span>
<span class="gi">+        }</span>
<span class="gi">+        void ParseOutput(const wxString&amp; output)</span>
<span class="gi">+        {</span>
<span class="gi">+            // Output:</span>
<span class="gi">+            // &lt;decimal process num&gt; id: &lt;hex PID&gt; create name: &lt;process name&gt;</span>
<span class="gi">+            wxArrayString lines = GetArrayFromString(output, _T(&#39;\n&#39;));</span>
<span class="gi">+            for (unsigned int i = 0; i &lt; lines.GetCount(); ++i)</span>
<span class="gi">+            {</span>
<span class="gi">+                if (reProcessInf.Matches(lines[i]))</span>
<span class="gi">+                {</span>
<span class="gi">+                    wxString hexID = reProcessInf.GetMatch(lines[i],1);</span>
<span class="gi">+</span>
<span class="gi">+                    long pid;</span>
<span class="gi">+                    if (hexID.ToLong(&amp;pid,16))</span>
<span class="gi">+                    {</span>
<span class="gi">+                        m_pDriver-&gt;SetChildPID(pid);</span>
<span class="gi">+                    }</span>
<span class="gi">+                }</span>
<span class="gi">+            }</span>
<span class="gi">+        }</span>
<span class="gi">+};</span>
<span class="gi">+</span>
<span class="gi">+</span>
<span class="gi">+/**</span>
   * Command to add a breakpoint.
   */
 class CdbCmd_AddBreakpoint : public DebuggerCmd
<span class="gh">Index: src/plugins/debuggergdb/cdb_driver.cpp</span>
<span class="gh">===================================================================</span>
<span class="gd">--- src/plugins/debuggergdb/cdb_driver.cpp    (revision 6930)</span>
<span class="gi">+++ src/plugins/debuggergdb/cdb_driver.cpp    (working copy)</span>
<span class="gu">@@ -15,8 +15,11 @@</span>
 #include &lt;globals.h&gt;
 #include &lt;infowindow.h&gt;
 
<span class="gd">-#define CDB_PROMPT _T(&quot;0:000&gt;&quot;)</span>
<span class="gi">+#define ENABLE_WORKINGDIR_WORKAROUND</span>
<span class="gi">+#define CDB_STACKTRACE _T(&quot;ChildEBP&quot;)</span>
<span class="gi">+#define CDB_FRAMESWITCH _T(&quot;CBFrameSwitch&quot;)</span>
 
<span class="gi">+static wxRegEx rePrompt(_T(&quot;([0-9]+:){1,2}[0-9]+&gt;&quot;));</span>
 static wxRegEx reBP(_T(&quot;Breakpoint ([0-9]+) hit&quot;));
 // one stack frame (to access current file; is there another way???)
 //  # ChildEBP RetAddr
<span class="gu">@@ -24,7 +27,8 @@</span>
 static wxRegEx reFile(_T(&quot;[ \t]([A-z]+.*)[ \t]+\\[([A-z]:)(.*) @ ([0-9]+)\\]&quot;));
 
 CDB_driver::CDB_driver(DebuggerGDB* plugin)
<span class="gd">-    : DebuggerDriver(plugin)</span>
<span class="gi">+    : DebuggerDriver(plugin),</span>
<span class="gi">+    m_Debuggee(wxEmptyString)</span>
 {
     //ctor
 }
<span class="gu">@@ -63,8 +67,16 @@</span>
     cmd &lt;&lt; _T(&#39; &#39;) &lt;&lt; debuggee;
 
     if (!m_WorkingDir.IsEmpty())
<span class="gi">+    {</span>
         wxSetWorkingDirectory(m_WorkingDir);
 
<span class="gi">+#ifdef ENABLE_WORKINGDIR_WORKAROUND</span>
<span class="gi">+        // Because of the lack of ChDir functionality for a process which has already been launched,</span>
<span class="gi">+        // do a dodgy workaround by starting with a dummy version of the process, then starting in the right folder later.</span>
<span class="gi">+        m_Debuggee.assign(debuggee);</span>
<span class="gi">+#endif</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
     return cmd;
 }
 
<span class="gu">@@ -104,7 +116,28 @@</span>
 
 void CDB_driver::Prepare(ProjectBuildTarget* /*target*/, bool /*isConsole*/)
 {
<span class="gd">-    // default initialization</span>
<span class="gi">+    // CDB outputs a lot of spam to begin with, which mucks up output parsing without a dummy command first</span>
<span class="gi">+    m_QueueBusy = true;</span>
<span class="gi">+    QueueCommand(new DebuggerCmd(this,_T(&quot;.echo Clear initial spam&quot;)));</span>
<span class="gi">+</span>
<span class="gi">+#ifdef ENABLE_WORKINGDIR_WORKAROUND</span>
<span class="gi">+    if (!m_Debuggee.IsEmpty())</span>
<span class="gi">+    {</span>
<span class="gi">+        // Workaround for setting the correct working dir:</span>
<span class="gi">+        wxString cmd = _T(&quot;.kill; .createdir &quot;);</span>
<span class="gi">+        cmd &lt;&lt; m_WorkingDir;</span>
<span class="gi">+        QueueCommand(new DebuggerCmd(this,cmd)); // Kill the process and CD to the right place</span>
<span class="gi">+</span>
<span class="gi">+        cmd = _T(&quot;.create &quot;);</span>
<span class="gi">+        cmd &lt;&lt; m_Debuggee &lt;&lt; _T(&quot;; g&quot;);</span>
<span class="gi">+        QueueCommand(new DebuggerCmd(this,cmd)); // Restart the process in the correct directory</span>
<span class="gi">+</span>
<span class="gi">+        m_Debuggee.Clear();</span>
<span class="gi">+    }</span>
<span class="gi">+#endif</span>
<span class="gi">+</span>
<span class="gi">+    // Either way, get the PID of the child</span>
<span class="gi">+    QueueCommand(new CdbCmd_GetPID(this));</span>
 }
 
 void CDB_driver::Start(bool /*breakOnEntry*/)
<span class="gu">@@ -179,9 +212,11 @@</span>
     QueueCommand(new CdbCmd_InfoRegisters(this, m_pCPURegisters));
 }
 
<span class="gd">-void CDB_driver::SwitchToFrame(size_t /*number*/)</span>
<span class="gi">+void CDB_driver::SwitchToFrame(size_t number)</span>
 {
<span class="gd">-    NOT_IMPLEMENTED();</span>
<span class="gi">+    wxString cmd = _T(&quot;.echo &quot;); // Echo in our trace token to tell ParseOutput to update the frame.</span>
<span class="gi">+    cmd &lt;&lt; CDB_FRAMESWITCH &lt;&lt; _T(&quot;; .frame &quot;) &lt;&lt; number;</span>
<span class="gi">+    QueueCommand(new DebuggerCmd(this, cmd));</span>
 }
 
 void CDB_driver::SetVarValue(const wxString&amp; /*var*/, const wxString&amp; /*value*/)
<span class="gu">@@ -268,26 +303,32 @@</span>
 {
     m_Cursor.changed = false;
     static wxString buffer;
<span class="gi">+</span>
     buffer &lt;&lt; output &lt;&lt; _T(&#39;\n&#39;);
 
     m_pDBG-&gt;DebugLog(output);
 
<span class="gd">-    int idx = buffer.First(CDB_PROMPT);</span>
<span class="gd">-    if (idx != wxNOT_FOUND)</span>
<span class="gd">-    {</span>
<span class="gi">+    if (rePrompt.Matches(buffer))</span>
<span class="gi">+    {</span>
<span class="gi">+        int idx = buffer.First(rePrompt.GetMatch(buffer));</span>
<span class="gi">+        cbAssert(idx != wxNOT_FOUN</span>
<em><strong>file truncated...</strong></em>
</pre></div>

      <h4 class="page-header">History</h4>
      <div class="panel panel-default">
        <div class="panel-heading">etheranger 2011-01-16 04:47</div>
        <div class="panel-body">
          <p>Internal changes:</p>
          <p>+ Fix output parsing being one command out due to output spam at CDB's launch</p>
          <p>+ Fix command prompt recognition</p>
          <p>+ Find the debuggee's PID on launch so that the IDE can break / halt execution cleanly.</p>
          <p>Resultant functionality fixes:</p>
          <p>+ Recognise and update UI on code breakpoints (assert / asm int 3 / etc)</p>
          <p>+ Enable setting / unsetting breakpoints on the fly</p>
          <p>+ Support stack frame switching while broken (works a treat with <a href="3112.html" data-toggle="tooltip" title="CallStack switches frame when you double click on list">Patch #3112</a>!)</p>
          <p>This includes <a href="3117.html" data-toggle="tooltip" title="Correctly set CDB's working directory">Patch #3117</a>, but that workaround functionality can be disabled by commenting out by #undefining ENABLE_WORKINGDIR_WORKAROUND.</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">tpetrov 2011-01-16 15:06</div>
        <div class="panel-body">
          <p>Is this against trunk or against debuggers branch?</p>
          <p>If it is against trunk can you redo your patch for the branch?</p>
          <p>There are many changes related to the debugger in this branch.</p>
          <p>Also the CDB support is improved (I think).</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">etheranger 2011-01-17 02:17</div>
        <div class="panel-body">
          <p>It's against trunk, I just wanted to get a stable-ish build up and running for my use.</p>
          <p>I'll take a look at the debugger branch next time I get a chance (in a week or so).</p>
        </div>
      </div>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script>
      $(document).ready(function() {
        $("body").tooltip({ selector: '[data-toggle=tooltip]' });
      });
    </script>
  </body>
</html>