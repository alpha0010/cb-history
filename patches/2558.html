<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Patch 2558 - Code::Blocks History</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="../pygments.css">
  </head>
  <body role="document">
    <div class="navbar navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://www.codeblocks.org/">Code::Blocks</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../index.html">Home</a></li>
            <li><a href="../bugs.html">Bugs</a></li>
            <li><a href="../features.html">Features</a></li>
            <li class="active"><a href="../patches.html">Patches</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container" role="main">
      <div class="row">
        <div class="col-sm-8">
          <h3>Patch #2558 <small>2008-09-06 23:33</small></h3>
          <h4>gryphon</h4>
          Can specify the execution directory for a custom makefile 
          <dl class="dl-horizontal">
            <dt>Download</dt>
            <dd><a href="2558-Can_specify_th.patch">2558-Can_specify_th.patch</a> (17.5 KB)</dd>
          </dl>
        </div>
        <div class="col-sm-4">
          <dl class="dl-horizontal">
            <dt>Category</dt><dd>Application::Refinement</dd>
            <dt>Status</dt><dd>Accepted</dd>
            <dt>Close date</dt><dd>2009-04-02 22:16 <a href="http://cb.biplab.in/websvn/log.php?sr=5497"><span class="glyphicon glyphicon-link"></span></a></dd>
            <dt>Assigned to</dt><dd>jenslody</dd>
          </dl>
        </div>
      </div>
      <div class="highlight"><pre class="pre-scrollable"><span class="gh">Index: src/sdk/cbproject.cpp</span>
<span class="gh">===================================================================</span>
<span class="gd">--- src/sdk/cbproject.cpp    (revision 5201)</span>
<span class="gi">+++ src/sdk/cbproject.cpp    (working copy)</span>
<span class="gu">@@ -1550,6 +1550,25 @@</span>
     return m_Makefile;
 }
 
<span class="gi">+void cbProject::SetMakefileExecutionDir(const wxString&amp; dir)</span>
<span class="gi">+{</span>
<span class="gi">+    if (m_MakefileExecutionDir != dir)</span>
<span class="gi">+    {</span>
<span class="gi">+        m_MakefileExecutionDir = dir;</span>
<span class="gi">+        SetModified(true);</span>
<span class="gi">+    }</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+const wxString&amp; cbProject::GetMakefileExecutionDir() const</span>
<span class="gi">+{</span>
<span class="gi">+    if (!m_MakefileExecutionDir.IsEmpty())</span>
<span class="gi">+        return m_MakefileExecutionDir;</span>
<span class="gi">+</span>
<span class="gi">+    wxFileName makefile_execution_dir(GetBasePath());</span>
<span class="gi">+    m_MakefileExecutionDir = makefile_execution_dir.GetFullPath();</span>
<span class="gi">+    return m_MakefileExecutionDir;</span>
<span class="gi">+}</span>
<span class="gi">+</span>
 ProjectFile* cbProject::GetFile(int index)
 {
     FilesList::Node* node = m_Files.Item(index);
<span class="gh">Index: src/sdk/projectoptionsdlg.cpp</span>
<span class="gh">===================================================================</span>
<span class="gd">--- src/sdk/projectoptionsdlg.cpp    (revision 5201)</span>
<span class="gi">+++ src/sdk/projectoptionsdlg.cpp    (working copy)</span>
<span class="gu">@@ -68,6 +68,7 @@</span>
     EVT_BUTTON(    XRCID(&quot;btnBrowseOutputFilename&quot;),   ProjectOptionsDlg::OnBrowseOutputFilenameClick)
     EVT_BUTTON(    XRCID(&quot;btnBrowseWorkingDir&quot;),       ProjectOptionsDlg::OnBrowseDirClick)
     EVT_BUTTON(    XRCID(&quot;btnBrowseObjectDir&quot;),        ProjectOptionsDlg::OnBrowseDirClick)
<span class="gi">+    EVT_BUTTON(    XRCID(&quot;btnMakefileExecutionDir&quot;),   ProjectOptionsDlg::OnBrowseDirClick)</span>
     EVT_BUTTON(    XRCID(&quot;btnVirtualBuildTargets&quot;),    ProjectOptionsDlg::OnVirtualTargets)
     EVT_BUTTON(    XRCID(&quot;btnExternalDeps&quot;),           ProjectOptionsDlg::OnEditDepsClick)
     EVT_BUTTON(    XRCID(&quot;btnExportTarget&quot;),           ProjectOptionsDlg::OnExportTargetClick)
<span class="gu">@@ -110,6 +111,7 @@</span>
     XRCCTRL(*this, &quot;txtPlatformProj&quot;, wxTextCtrl)-&gt;SetValue(GetStringFromPlatforms(m_Project-&gt;GetPlatforms()));
     XRCCTRL(*this, &quot;txtProjectMakefile&quot;, wxTextCtrl)-&gt;SetValue(m_Project-&gt;GetMakefile());
     XRCCTRL(*this, &quot;chkCustomMakefile&quot;, wxCheckBox)-&gt;SetValue(m_Project-&gt;IsMakefileCustom());
<span class="gi">+    XRCCTRL(*this, &quot;txtMakefileExecutionDir&quot;, wxTextCtrl)-&gt;SetValue(m_Project-&gt;GetMakefileExecutionDir());</span>
     XRCCTRL(*this, &quot;rbPCHStrategy&quot;, wxRadioBox)-&gt;SetSelection((int)m_Project-&gt;GetModeForPCH());
 
     Compiler* compiler = CompilerFactory::GetCompiler(project-&gt;GetCompilerID());
<span class="gu">@@ -687,6 +689,8 @@</span>
         targettext = XRCCTRL(*this, &quot;txtWorkingDir&quot;, wxTextCtrl);
     else if (event.GetId() == XRCID(&quot;btnBrowseObjectDir&quot;))
         targettext = XRCCTRL(*this, &quot;txtObjectDir&quot;, wxTextCtrl);
<span class="gi">+    else if (event.GetId() == XRCID(&quot;btnMakefileExecutionDir&quot;))</span>
<span class="gi">+        targettext = XRCCTRL(*this, &quot;txtMakefileExecutionDir&quot;, wxTextCtrl);</span>
     else
         return;
 
<span class="gu">@@ -1021,6 +1025,10 @@</span>
     XRCCTRL(*this, &quot;btnToggleCheckmarks&quot;, wxButton)-&gt;Enable(!customMake &amp;&amp; en);
     list-&gt;Enable(!customMake);
 
<span class="gi">+    // enable some stuff if using a custom makefile</span>
<span class="gi">+    XRCCTRL(*this, &quot;txtMakefileExecutionDir&quot;, wxTextCtrl)-&gt;Enable(customMake);</span>
<span class="gi">+    XRCCTRL(*this, &quot;btnMakefileExecutionDir&quot;, wxTextCtrl)-&gt;Enable(customMake);</span>
<span class="gi">+</span>
     // scripts page
     wxTreeCtrl* tc = XRCCTRL(*this, &quot;tcOverview&quot;, wxTreeCtrl);
     tc-&gt;Enable(!customMake);
<span class="gu">@@ -1055,6 +1063,7 @@</span>
         m_Project-&gt;RenameInTree(m_Project-&gt;GetTitle());
         m_Project-&gt;SetMakefile(XRCCTRL(*this, &quot;txtProjectMakefile&quot;, wxTextCtrl)-&gt;GetValue());
         m_Project-&gt;SetMakefileCustom(XRCCTRL(*this, &quot;chkCustomMakefile&quot;, wxCheckBox)-&gt;GetValue());
<span class="gi">+        m_Project-&gt;SetMakefileExecutionDir(XRCCTRL(*this, &quot;txtMakefileExecutionDir&quot;, wxTextCtrl)-&gt;GetValue());</span>
         m_Project-&gt;SetTargetType(TargetType(XRCCTRL(*this, &quot;cmbProjectType&quot;, wxComboBox)-&gt;GetSelection()));
         m_Project-&gt;SetModeForPCH((PCHMode)XRCCTRL(*this, &quot;rbPCHStrategy&quot;, wxRadioBox)-&gt;GetSelection());
         m_Project-&gt;SetExtendedObjectNamesGeneration(XRCCTRL(*this, &quot;chkExtendedObjNames&quot;, wxCheckBox)-&gt;GetValue());
<span class="gh">Index: src/sdk/projectloader.cpp</span>
<span class="gh">===================================================================</span>
<span class="gd">--- src/sdk/projectloader.cpp    (revision 5201)</span>
<span class="gi">+++ src/sdk/projectloader.cpp    (working copy)</span>
<span class="gu">@@ -377,6 +377,7 @@</span>
     wxString title;
     wxString makefile;
     bool makefile_custom = false;
<span class="gi">+    wxString makefile_execution_dir;</span>
     wxString defaultTarget;
     wxString compilerId = _T(&quot;gcc&quot;);
     bool extendedObjectNames = false;
<span class="gu">@@ -405,6 +406,9 @@</span>
         else if (node-&gt;Attribute(&quot;makefile_is_custom&quot;))
             makefile_custom = strncmp(node-&gt;Attribute(&quot;makefile_is_custom&quot;), &quot;1&quot;, 1) == 0;
 
<span class="gi">+        else if (node-&gt;Attribute(&quot;makefile_execution_dir&quot;))</span>
<span class="gi">+            makefile_execution_dir = cbC2U(node-&gt;Attribute(&quot;makefile_execution_dir&quot;));</span>
<span class="gi">+</span>
         // old default_target (int) node
         else if (node-&gt;QueryIntAttribute(&quot;default_target&quot;, &amp;m_1_4_to_1_5_deftarget) == TIXML_SUCCESS)
         {
<span class="gu">@@ -442,6 +446,7 @@</span>
     m_pProject-&gt;SetPlatforms(platformsFinal);
     m_pProject-&gt;SetMakefile(makefile);
     m_pProject-&gt;SetMakefileCustom(makefile_custom);
<span class="gi">+    m_pProj</span>
<em><strong>download for full patch...</strong></em>
</pre></div>

      <h4 class="page-header">History</h4>
      <div class="panel panel-default">
        <div class="panel-heading">gryphon 2008-09-06 23:46</div>
        <div class="panel-body">
          <p>For some projects that make use of a custom makefile it is required that the execution directory of the makefile be specified. Paths within the makefile are relative to this execution directory and so will not be found.</p>
          <p>For example given the following locations:</p>
          <p>base/build/aaaa/source/sub_source/file.cpp</p>
          <p>base/build/aaaa/source/Makefile</p>
          <p>base/cbs/project/project.cbp</p>
          <p>The makefile references files as:</p>
          <p>./source/sub_source/file.cpp</p>
          <p>The patch basically allows specification of an execution directory for the makefile other than the default of:</p>
          <p>base/cbs/project/</p>
          <p>In this case the required execution working directory would be:</p>
          <p>../../build/aaaa</p>
          <p>The patch then attempts to perform two things:</p>
          <p>1. It sets the correct directory for the piped process that runs make to the execution directory specified.</p>
          <p>2. It changes the logged compile error and warning file paths into valid paths by combining the makefile execution directory and the invalid relative path taken from the makefile. This ensures that clicking on such error and warning messages results in the correct line in the correct file being focused as usual.</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">gryphon 2008-09-07 15:16</div>
        <div class="panel-body">
          <p>Uploading a revised version of the patch that provides two important changes:</p>
          <p>1. Custom Makefile commands are now inherited from the project if they are not present in the target.</p>
          <p>2. Codeblocks variables now get replaced inside the makefile commands.</p>
          <p>These changes allow a project to define a 'master' makefile command with variables and have targets specify values for those variables and hence allow a high degree of flexibility when forced to use a custom makefile.</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">jenslody 2009-04-02 22:16</div>
        <div class="panel-body">
          <p>The patch is added to trunk in slightly modified form (svn r5497)</p>
          <p>Thanks for your effort,</p>
          <p>Jens</p>
        </div>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
  </body>
</html>
