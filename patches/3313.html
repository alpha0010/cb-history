<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Patch 3313 - Code::Blocks History</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="../pygments.css">
  </head>
  <body role="document">
    <div class="navbar navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://www.codeblocks.org/">Code::Blocks</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../index.html">Home</a></li>
            <li><a href="../bugs.html">Bugs</a></li>
            <li><a href="../features.html">Features</a></li>
            <li class="active"><a href="../patches.html">Patches</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container" role="main">
      <div class="row">
        <div class="col-sm-8">
          <h3>Patch #3313 <small>2012-08-07 15:33</small></h3>
          <h4>alpha0010</h4>
          Improve handling of inactive preprocessor code
          <dl class="dl-horizontal">
            <dt>Download</dt>
            <dd><a href="3313-Improve_handli.patch">3313-Improve_handli.patch</a> (32.0 KB)</dd>
          </dl>
        </div>
        <div class="col-sm-4">
          <dl class="dl-horizontal">
            <dt>Category</dt><dd>Lexer</dd>
            <dt>Status</dt><dd>Accepted</dd>
            <dt>Close date</dt><dd>2012-08-13 05:23 <a href="http://cb.biplab.in/websvn/log.php?sr=8231"><span class="glyphicon glyphicon-link"></span></a></dd>
            <dt>Assigned to</dt><dd>mortenmacfly</dd>
          </dl>
        </div>
      </div>
      <div class="highlight"><pre class="pre-scrollable"><span class="gh">Index: src/sdk/editorconfigurationdlg.cpp</span>
<span class="gh">===================================================================</span>
<span class="gd">--- src/sdk/editorconfigurationdlg.cpp    (revision 8219)</span>
<span class="gi">+++ src/sdk/editorconfigurationdlg.cpp    (working copy)</span>
<span class="gu">@@ -141,6 +141,8 @@</span>
     XRCCTRL(*this, &quot;rbTabText&quot;,                   wxRadioBox)-&gt;SetSelection(cfg-&gt;ReadBool(_T(&quot;/tab_text_relative&quot;),      true)? 1 : 0);
 
     XRCCTRL(*this, &quot;chkTrackPreprocessor&quot;,        wxCheckBox)-&gt;SetValue(cfg-&gt;ReadBool(_T(&quot;/track_preprocessor&quot;),         false));
<span class="gi">+    XRCCTRL(*this, &quot;chkCollectPrjDefines&quot;,        wxCheckBox)-&gt;SetValue(cfg-&gt;ReadBool(_T(&quot;/collect_prj_defines&quot;),        false));</span>
<span class="gi">+    XRCCTRL(*this, &quot;chkPlatDefines&quot;,              wxCheckBox)-&gt;SetValue(cfg-&gt;ReadBool(_T(&quot;/platform_defines&quot;),           false));</span>
     XRCCTRL(*this, &quot;chkColoursWxSmith&quot;,           wxCheckBox)-&gt;SetValue(cfg-&gt;ReadBool(_T(&quot;/highlight_wxsmith&quot;),          true));
 
 #if defined __WXMSW__
<span class="gu">@@ -152,7 +154,7 @@</span>
 #endif
     XRCCTRL(*this, &quot;txtOpenFolder&quot;, wxTextCtrl)-&gt;SetValue(cfg-&gt;Read(_T(&quot;/open_containing_folder&quot;), openFolderCmds));
 
<span class="gd">-    // Highlight Occurence</span>
<span class="gi">+    // Highlight Occurrence</span>
     bool highlightEnabled = cfg-&gt;ReadBool(_T(&quot;/highlight_occurrence/enabled&quot;), true);
     XRCCTRL(*this, &quot;chkHighlightOccurrences&quot;,              wxCheckBox)-&gt;SetValue(highlightEnabled);
     XRCCTRL(*this, &quot;chkHighlightOccurrencesCaseSensitive&quot;, wxCheckBox)-&gt;SetValue(cfg-&gt;ReadBool(_T(&quot;/highlight_occurrence/case_sensitive&quot;), true));
<span class="gu">@@ -814,6 +816,8 @@</span>
         cfg-&gt;Write(_T(&quot;/camel_case&quot;),                          XRCCTRL(*this, &quot;chkCamelCase&quot;,          wxCheckBox)-&gt;GetValue());
 
         cfg-&gt;Write(_T(&quot;/track_preprocessor&quot;),                  XRCCTRL(*this, &quot;chkTrackPreprocessor&quot;,  wxCheckBox)-&gt;GetValue());
<span class="gi">+        cfg-&gt;Write(_T(&quot;/collect_prj_defines&quot;),                 XRCCTRL(*this, &quot;chkCollectPrjDefines&quot;,  wxCheckBox)-&gt;GetValue());</span>
<span class="gi">+        cfg-&gt;Write(_T(&quot;/platform_defines&quot;),                    XRCCTRL(*this, &quot;chkPlatDefines&quot;,        wxCheckBox)-&gt;GetValue());</span>
         cfg-&gt;Write(_T(&quot;/highlight_wxsmith&quot;),                   XRCCTRL(*this, &quot;chkColoursWxSmith&quot;,     wxCheckBox)-&gt;GetValue());
 
         bool resetZoom = XRCCTRL(*this, &quot;chkResetZoom&quot;, wxCheckBox)-&gt;GetValue();
<span class="gh">Index: src/sdk/cbeditor.cpp</span>
<span class="gh">===================================================================</span>
<span class="gd">--- src/sdk/cbeditor.cpp    (revision 8219)</span>
<span class="gi">+++ src/sdk/cbeditor.cpp    (working copy)</span>
<span class="gu">@@ -2570,6 +2570,49 @@</span>
     if (matchingBrace == wxSCI_INVALID_POSITION)
         matchingBrace = control-&gt;BraceMatch(control-&gt;GetCurrentPos() - 1);
 
<span class="gi">+    // else look for a matching preprocessor command</span>
<span class="gi">+    if (matchingBrace == wxSCI_INVALID_POSITION)</span>
<span class="gi">+    {</span>
<span class="gi">+        wxRegEx ppIf(wxT(&quot;^[ \t]*#[ \t]*if&quot;));</span>
<span class="gi">+        wxRegEx ppElse(wxT(&quot;^[ \t]*#[ \t]*el&quot;));</span>
<span class="gi">+        wxRegEx ppEnd(wxT(&quot;^[ \t]*#[ \t]*endif&quot;));</span>
<span class="gi">+        wxRegEx pp(wxT(&quot;^[ \t]*#[ \t]*[a-z]*&quot;)); // generic match to get length</span>
<span class="gi">+        if (ppIf.Matches(control-&gt;GetCurLine()) || ppElse.Matches(control-&gt;GetCurLine()))</span>
<span class="gi">+        {</span>
<span class="gi">+            int depth = 1; // search forwards</span>
<span class="gi">+            for (int i = control-&gt;GetCurrentLine() + 1; i &lt; control-&gt;GetLineCount(); ++i)</span>
<span class="gi">+            {</span>
<span class="gi">+                if (ppIf.Matches(control-&gt;GetLine(i))) // ignore else&#39;s, elif&#39;s, ...</span>
<span class="gi">+                    ++depth;</span>
<span class="gi">+                else if (ppEnd.Matches(control-&gt;GetLine(i)))</span>
<span class="gi">+                    --depth;</span>
<span class="gi">+                if (depth == 0)</span>
<span class="gi">+                {</span>
<span class="gi">+                    pp.Matches(control-&gt;GetLine(i));</span>
<span class="gi">+                    matchingBrace = control-&gt;PositionFromLine(i) + pp.GetMatch(control-&gt;GetLine(i)).Length();</span>
<span class="gi">+                    break;</span>
<span class="gi">+                }</span>
<span class="gi">+            }</span>
<span class="gi">+        }</span>
<span class="gi">+        else if (ppEnd.Matches(control-&gt;GetCurLine()))</span>
<span class="gi">+        {</span>
<span class="gi">+            int depth = -1; // search backwards</span>
<span class="gi">+            for (int i = control-&gt;GetCurrentLine() - 1; i &gt; 0; --i)</span>
<span class="gi">+            {</span>
<span class="gi">+                if (ppIf.Matches(control-&gt;GetLine(i))) // ignore else&#39;s, elif&#39;s, ...</span>
<span class="gi">+                    ++depth;</span>
<span class="gi">+                else if (ppEnd.Matches(control-&gt;GetLine(i)))</span>
<span class="gi">+                    --depth;</span>
<span class="gi">+                if (depth == 0)</span>
<span class="gi">+                {</span>
<span class="gi">+                    pp.Matches(control-&gt;GetLine(i));</span>
<span class="gi">+                    matchingBrace = control-&gt;PositionFromLine(i) + pp.GetMatch(control-&gt;GetLine(i)).Length();</span>
<span class="gi">+                    break;</span>
<span class="gi">+                }</span>
<span class="gi">+            }</span>
<span class="gi">+        }</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
     // now, we either found it or not
     if (matchingBrace != wxSCI_INVALID_POSITION)
         control-&gt;GotoPos(matchingBrace);
<span class="gh">Index: src/sdk/wxscintilla/src/scintilla/lexers/LexCPP.cxx</span>
<span class="gh">===================================================================</span>
<span class="gd">--- src/sdk/wxscintilla/src/scintilla/lexers/LexCPP.cxx    (revision 8219)</span>
<span class="gi">+++ src/sdk/wxscintilla/src/scintilla/lexers/LexCPP.cxx    (working copy)</span>
<span class="gu">@@ -88,6 +88,11 @@</span>
     int i =0;
     char ch = styler.SafeGetCharAt(start, &#39;\n&#39;);
     while ((ch != &#39;\r&#39;) &amp;&amp; (ch != &#39;\n&#39;)) {
<span class="gi">+/* C::B begin */</span>
<span class="gi">+        if (ch == &#39;/&#39; &amp;&amp; (styler.SafeGetCharAt(start + i + 1, &#39;\n&#39;) == &#39;/&#39; ||</span>
<span class="gi">+</span>
<em><strong>download for full patch...</strong></em>
</pre></div>

      <h4 class="page-header">History</h4>
      <div class="panel panel-default">
        <div class="panel-heading">mortenmacfly 2012-08-07 16:03</div>
        <div class="panel-body">
          <p>Just one note:</p>
          <p>(editormanager is screwed anyways... but...) Next time you add a method please keep the order in the implementation file the same as is the header. Not at the bottom.</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">alpha0010 2012-08-07 18:05</div>
        <div class="panel-body">
          <p>OK; I think it is in the correct position now.  (I also added a bit more to define collection.)</p>
          <p>From my testing, the modifications in this patch (when define collection is enabled) give correct highlighting almost all of the time.  Because of this and that greyed out code now remains syntax highlighted, I would recommend that both interpreting preprocessor code and define collection be enabled by default; what do you think?  (They are both currently disabled by default.)</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">mortenmacfly 2012-08-08 05:00</div>
        <div class="panel-body">
          <p>BTW what doesn't work for me w/ highlighting is the wxWidgets stuff. I wonder if you should add the __WXMSW__ stuff (and others), too...?!</p>
          <p>Oh - and btw: What, if I cross-compile? In that case I don't want i.e. the Linux defines to be set automatically, so actually the platform should be an option, too. The same (eve harder) applies to the no. of bits: Most of the time I am compiling 32 bit apps on a 64 Windows, like C::B. :-)</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">alpha0010 2012-08-08 12:04</div>
        <div class="panel-body">
          <p>From what I can tell, normally items like __WXMSW__ should be defined in the project file.  When loading completes, and each time a build target is switched, the compiler switches are re-scanned for defines (assuming define collection is enabled).  However, the current editor must be closed/reopened to refresh its define list (I could not yet find a workaround for this).  When I tested on, for example, CodeBlocks.cbp, all (simple to moderate complexity) wxWidgets and pch related defines worked correctly.</p>
          <p>I could additionally add some of these defines with the platform specific ones.</p>
          <p>I forgot about cross compiling... I will add a switch to control platform specific defines.</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">alpha0010 2012-08-10 04:34</div>
        <div class="panel-body">
          <p>Platform defines now have a check-box.</p>
          <p>I was unable to replicate your issue with wxWidgets projects, so there is nothing new here specifically targeting to fix that.</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">mortenmacfly 2012-08-11 10:14</div>
        <div class="panel-body">
          <p>Looks OK now. The reason with the wxWidgets was another one... not related to this patch. Let me do some testing and then I think I can commit...</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">mortenmacfly 2012-08-13 05:23</div>
        <div class="panel-body">
          <p>Works - Applied - Thanks! :-)</p>
        </div>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
  </body>
</html>
