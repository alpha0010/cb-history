<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Patch 1740 - Code::Blocks History</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css">
  </head>
  <body role="document">
    <div class="navbar navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://www.codeblocks.org/">Code::Blocks</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../index.html">Home</a></li>
            <li><a href="../bugs.html">Bugs</a></li>
            <li><a href="../features.html">Features</a></li>
            <li class="active"><a href="../patches.html">Patches</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container" role="main">
      <div class="row">
        <div class="col-sm-8">
          <h3>Patch #1740 <small>2006-12-19 08:01</small></h3>
          <h4>mcdave</h4>
          Code Fold at Marked Line Bug Fix
          <dl class="dl-horizontal">
            <dt>Download</dt>
            <dd><a href="1740-Code_Fold_at_M.patch">1740-Code_Fold_at_M.patch</a> (3.3 KB)</dd>
          </dl>
        </div>
        <div class="col-sm-4">
          <dl class="dl-horizontal">
            <dt>Category</dt><dd>Application::Bugfix</dd>
            <dt>Status</dt><dd>Closed</dd>
            <dt>Close date</dt><dd>2007-04-06 14:25 <a href="http://cb.biplab.in/websvn/log.php?sr=3816"><span class="glyphicon glyphicon-link"></span></a></dd>
            <dt>Assigned to</dt><dd>killerbot</dd>
          </dl>
        </div>
      </div>
      <div class="highlight"><pre class="pre-scrollable"><span class="gh">Index: src/sdk/cbeditor.cpp</span>
<span class="gh">===================================================================</span>
<span class="gd">--- src/sdk/cbeditor.cpp    (revision 3455)</span>
<span class="gi">+++ src/sdk/cbeditor.cpp    (working copy)</span>
<span class="gu">@@ -1467,13 +1467,37 @@</span>
 
 void cbEditor::DoFoldBlockFromLine(int line, int fold)
 {
<span class="gd">-    m_pControl-&gt;Colourise(0, -1); // the *most* important part!</span>
<span class="gi">+    /*m_pControl-&gt;Colourise(0, -1); // the *most* important part!</span>
     int i = line;
     while (i != 0)
     {
         if (DoFoldLine(i, fold))
             return;
         --i;
<span class="gi">+    }*/</span>
<span class="gi">+    </span>
<span class="gi">+    ConfigManager* mgr = Manager::Get()-&gt;GetConfigManager(_T(&quot;editor&quot;));</span>
<span class="gi">+    if (mgr-&gt;ReadBool(_T(&quot;/folding/show_folds&quot;), true)) //Only unfold the marked line if the folds are enabled ... duh</span>
<span class="gi">+    {</span>
<span class="gi">+        m_pControl-&gt;Colourise(0, -1); // the *most* important part!</span>
<span class="gi">+        int level = m_pControl-&gt;GetFoldLevel(line);</span>
<span class="gi">+        int parent = m_pControl-&gt;GetFoldParent(line);</span>
<span class="gi">+        </span>
<span class="gi">+        //Check for fold headers</span>
<span class="gi">+        if ((level &amp; wxSCI_FOLDLEVELHEADERFLAG) &amp;&amp; (wxSCI_FOLDLEVELBASE &lt;= (level &amp; wxSCI_FOLDLEVELNUMBERMASK)))</span>
<span class="gi">+           parent = line;</span>
<span class="gi">+        if (parent != -1)</span>
<span class="gi">+        {</span>
<span class="gi">+            if (m_pControl-&gt;GetFoldExpanded(parent) == false &amp;&amp; fold == 0)</span>
<span class="gi">+                m_pControl-&gt;ToggleFold(parent);</span>
<span class="gi">+            else</span>
<span class="gi">+            {</span>
<span class="gi">+                if (m_pControl-&gt;GetFoldExpanded(parent) == true &amp;&amp; fold == 1)</span>
<span class="gi">+                    m_pControl-&gt;ToggleFold(parent);</span>
<span class="gi">+                else if (fold == 2)</span>
<span class="gi">+                    m_pControl-&gt;ToggleFold(parent);</span>
<span class="gi">+            }</span>
<span class="gi">+        }</span>
     }
 }
 
<span class="gu">@@ -1569,8 +1593,23 @@</span>
         control-&gt;GotoLine(line - onScreen);
         control-&gt;GotoLine(line + onScreen);
     }
<span class="gi">+    </span>
<span class="gi">+    ConfigManager* mgr = Manager::Get()-&gt;GetConfigManager(_T(&quot;editor&quot;));</span>
<span class="gi">+    if (mgr-&gt;ReadBool(_T(&quot;/folding/show_folds&quot;), true)) //Only unfold the marked line if the folds are enabled ... duh</span>
<span class="gi">+    {</span>
<span class="gi">+        m_pControl-&gt;Colourise(0, -1); // the *most* important part!</span>
<span class="gi">+        </span>
<span class="gi">+        int parent = m_pControl-&gt;GetFoldParent(line);</span>
<span class="gi">+        while (parent != -1) //Unfold all the parent folds to ensure that the line is visible correctly</span>
<span class="gi">+        {</span>
<span class="gi">+            if (m_pControl-&gt;GetFoldExpanded(parent) == false)</span>
<span class="gi">+                m_pControl-&gt;ToggleFold(parent);</span>
<span class="gi">+            </span>
<span class="gi">+            parent = m_pControl-&gt;GetFoldParent(parent);</span>
<span class="gi">+        }</span>
<span class="gi">+    }</span>
<span class="gi">+    </span>
     control-&gt;GotoLine(line);
<span class="gd">-    UnfoldBlockFromLine(line); // make sure it&#39;s visible (not folded)</span>
 }
 
 bool cbEditor::AddBreakpoint(int line, bool notifyDebugger)
<span class="gu">@@ -1804,7 +1843,23 @@</span>
     if (line == -1)
         m_pControl-&gt;MarkerDeleteAll(marker);
     else
<span class="gi">+    {</span>
<span class="gi">+        ConfigManager* mgr = Manager::Get()-&gt;GetConfigManager(_T(&quot;editor&quot;));</span>
<span class="gi">+        if (mgr-&gt;ReadBool(_T(&quot;/folding/show_folds&quot;), true)) //Only unfold the marked line if the folds are enabled ... duh</span>
<span class="gi">+        {</span>
<span class="gi">+            m_pControl-&gt;Colourise(0, -1); // the *most* important part!</span>
<span class="gi">+            int parent = m_pControl-&gt;GetFoldParent(line);</span>
<span class="gi">+            while (parent != -1) //Unfold all the parent folds to ensure that the line is visible correctly</span>
<span class="gi">+            {</span>
<span class="gi">+                if (m_pControl-&gt;GetFoldExpanded(parent) == false)</span>
<span class="gi">+                    m_pControl-&gt;ToggleFold(parent);</span>
<span class="gi">+                </span>
<span class="gi">+                parent = m_pControl-&gt;GetFoldParent(parent);</span>
<span class="gi">+            }</span>
<span class="gi">+        }</span>
<span class="gi">+        </span>
         m_pControl-&gt;MarkerAdd(line, marker);
<span class="gi">+    }</span>
 }
 
 void cbEditor::GotoMatchingBrace()
</pre></div>

      <h4 class="page-header">History</h4>
      <div class="panel panel-default">
        <div class="panel-heading">mcdave 2006-12-19 09:36</div>
        <div class="panel-body">
          <p>This patch ensures the when the compiler marks a line as error/warning, or when it searches for something, that it will first unfold all of the parent fold then mark the line.</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">mcdave 2006-12-19 11:47</div>
        <div class="panel-body">
          <p>A nasty search and goto bug occured, this new patch fixes that issue. This patch also fixes the issue mentioned in that forum post killerbot. The issue was regarding the fold and unfold of blocks. This currently works correctly.</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">mcdave 2006-12-19 11:57</div>
        <div class="panel-body">
          <p>Hey killerbot... what do you think about that request that a user should be able to select which levels should be folded and which ones not (The depth part of it)</p>
          <p>Makes sense... but hell... will you ever satisfy everybody?</p>
          <p>We all have different coding styles...</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">kkez 2006-12-30 16:30</div>
        <div class="panel-body">
          <pre class="pre-scrollable">Here's the patch before astyle was used.

Index: cbeditor.cpp
===================================================================
--- cbeditor.cpp	(revision 3434)
+++ cbeditor.cpp	(working copy)
@@ -1467,13 +1467,37 @@

 void cbEditor::DoFoldBlockFromLine(int line, int fold)
 {
-    m_pControl-&gt;Colourise(0, -1); // the *most* important part!
+    /*m_pControl-&gt;Colourise(0, -1); // the *most* important part!
     int i = line;
     while (i != 0)
     {
         if (DoFoldLine(i, fold))
             return;
         --i;
+    }*/
+
+    ConfigManager* mgr = Manager::Get()-&gt;GetConfigManager(_T("editor"));
+    if (mgr-&gt;ReadBool(_T("/folding/show_folds"), true)) //Only unfold the marked line if the folds are enabled ... duh
+    {
+        m_pControl-&gt;Colourise(0, -1); // the *most* important part!
+        int level = m_pControl-&gt;GetFoldLevel(line);
+        int parent = m_pControl-&gt;GetFoldParent(line);
+
+        //Check for fold headers
+        if ((level &amp; wxSCI_FOLDLEVELHEADERFLAG) &amp;&amp; (wxSCI_FOLDLEVELBASE &lt;= (level &amp; wxSCI_FOLDLEVELNUMBERMASK)))
+           parent = line;
+        if (parent != -1)
+        {
+            if (m_pControl-&gt;GetFoldExpanded(parent) == false &amp;&amp; fold == 0)
+                m_pControl-&gt;ToggleFold(parent);
+            else
+            {
+                if (m_pControl-&gt;GetFoldExpanded(parent) == true &amp;&amp; fold == 1)
+                    m_pControl-&gt;ToggleFold(parent);
+                else if (fold == 2)
+                    m_pControl-&gt;ToggleFold(parent);
+            }
+        }
     }
 }

@@ -1569,8 +1593,23 @@
         control-&gt;GotoLine(line - onScreen);
         control-&gt;GotoLine(line + onScreen);
     }
+
+    ConfigManager* mgr = Manager::Get()-&gt;GetConfigManager(_T("editor"));
+    if (mgr-&gt;ReadBool(_T("/folding/show_folds"), true)) //Only unfold the marked line if the folds are enabled ... duh
+    {
+        m_pControl-&gt;Colourise(0, -1); // the *most* important part!
+
+        int parent = m_pControl-&gt;GetFoldParent(line);
+        while (parent != -1) //Unfold all the parent folds to ensure that the line is visible correctly
+        {
+            if (m_pControl-&gt;GetFoldExpanded(parent) == false)
+                m_pControl-&gt;ToggleFold(parent);
+
+            parent = m_pControl-&gt;GetFoldParent(parent);
+        }
+    }
+
     control-&gt;GotoLine(line);
-    UnfoldBlockFromLine(line); // make sure it's visible (not folded)
 }

 bool cbEditor::AddBreakpoint(int line, bool notifyDebugger)
@@ -1804,7 +1843,23 @@
     if (line == -1)
         m_pControl-&gt;MarkerDeleteAll(marker);
     else
+    {
+        ConfigManager* mgr = Manager::Get()-&gt;GetConfigManager(_T("editor"));
+        if (mgr-&gt;ReadBool(_T("/folding/show_folds"), true)) //Only unfold the marked line if the folds are enabled ... duh
+        {
+            m_pControl-&gt;Colourise(0, -1); // the *most* important part!
+            int parent = m_pControl-&gt;GetFoldParent(line);
+            while (parent != -1) //Unfold all the parent folds to ensure that the line is visible correctly
+            {
+                if (m_pControl-&gt;GetFoldExpanded(parent) == false)
+                    m_pControl-&gt;ToggleFold(parent);
+
+                parent = m_pControl-&gt;GetFoldParent(parent);
+            }
+        }
+
         m_pControl-&gt;MarkerAdd(line, marker);
+    }
 }

 void cbEditor::GotoMatchingBrace()
</pre>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">kkez 2006-12-30 16:32</div>
        <div class="panel-body">
          <p>MMM. Better this way: <a href="http://www.winapizone.net/recursive_unfold_on_error.patch">http://www.winapizone.net/recursive_unfold_on_error.patch</a></p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">mcdave 2007-01-04 06:41</div>
        <div class="panel-body">
          <p>kkez's Version uploaded. Thanks</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">mcdave 2007-01-15 05:48</div>
        <div class="panel-body">
          <p>Testing?</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">biplab 2007-03-10 16:57</div>
        <div class="panel-body">
          <p>First 2/3 of patch has been applied in modified form.</p>
          <p>I could not understand the third part [bool cbEditor::AddBreakpoint(int line, bool notifyDebugger)]. In which situation it's useful?</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">biplab 2007-04-06 14:25</div>
        <div class="panel-body">
          <p>@killerbot</p>
          <p>I wrote previously that this patch has been reworked and applied. Thus I'm closing this patch report.</p>
        </div>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
  </body>
</html>
