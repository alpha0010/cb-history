<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Patch 2349 - Code::Blocks History</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css">
  </head>
  <body role="document">
    <div class="navbar navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://www.codeblocks.org/">Code::Blocks</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../index.html">Home</a></li>
            <li><a href="../bugs.html">Bugs</a></li>
            <li><a href="../features.html">Features</a></li>
            <li class="active"><a href="../patches.html">Patches</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container" role="main">
      <div class="row">
        <div class="col-sm-8">
          <h3>Patch #2349 <small>2008-01-27 23:23</small></h3>
          <h4>pecan</h4>
          Found cause of Debugger crash when deleting breakpoints
          <dl class="dl-horizontal">
            <dt>Download</dt>
            <dd><a href="2349-Found_cause_of.patch">2349-Found_cause_of.patch</a> (2.2 KB)</dd>
          </dl>
        </div>
        <div class="col-sm-4">
          <dl class="dl-horizontal">
            <dt>Category</dt><dd>&nbsp;</dd>
            <dt>Status</dt><dd>Closed</dd>
            <dt>Close date</dt><dd>2008-02-16 00:05 <a href="http://cb.biplab.in/websvn/log.php?sr=4879"><span class="glyphicon glyphicon-link"></span></a></dd>
            <dt>Assigned to</dt><dd>mandrav</dd>
          </dl>
        </div>
      </div>
      <div class="highlight"><pre class="pre-scrollable">Recently, I&#39;ve been running a pgm under the debugger that
causes CB to crash when I delete a breakpoint. But the pgm runs ok
when not being debugged.

So I placed asm(int3) traps until I bracked the problem.
It seems that GdbCmd_RemoveBreakpoint::ParseOutput is assigning
a -1 to a breakpoint that has already been deleted.
Here is a way to reproduce the error.

I do not know the debugger well enough to know how to fix it.

In debuggerstate.cpp at line 191, place a trap and note
the bp address that&#39;s being deleted.

DebuggerBreakpoint* DebuggerState::RemoveBreakpoint(int idx, bool deleteit)
{
    // do we have a valid index?
    if (idx &lt; 0 || idx &gt;= (int)m_Breakpoints.GetCount())
        return 0;
    // yes, remove it from the list
    DebuggerBreakpoint* bp = m_Breakpoints[idx];
    m_Breakpoints.RemoveAt(idx);

    // notify driver if it is active
    if (m_pDriver)
        m_pDriver-&gt;RemoveBreakpoint(bp);

    if (deleteit)
    {
        asm(&quot;int3&quot;); /*trap*/ //&lt;===============
        delete bp; //&lt;= look at bp address
        return 0;
    }
    return bp;
}


In gdb_command.h at line 777, place the following trap.
when the debugger stops at &quot;cmd-&gt;ParseOutput(buffer.Left(idx));&quot;
step int the GdbCmd_RemoveBreakpoint() routine and
look at m_BP of the line: &quot;m_BP-&gt;index = -1;&quot;.
m_BP is the exact address of the bp that got previously deleted.

class GdbCmd_RemoveBreakpoint : public DebuggerCmd
{
    &lt; lines skipped&gt;

//        DebugLog(wxString::Format(_T(&quot;Command parsing output (cmd: %s): %s&quot;), cmd-&gt;m_Cmd.c_str(), buffer.Left(idx).c_str()));
        RemoveTopCommand(false);
        buffer.Remove(idx);
        // remove the &#39;&gt;&gt;&gt;&gt;&gt;&gt;&#39; part of the prompt (or what&#39;s left of it)
        int cnt = 6; // max 6 &#39;&gt;&#39;
        while (buffer.Last() == _T(&#39;&gt;&#39;) &amp;&amp; cnt--)
            buffer.RemoveLast();
        if (buffer.Last() == _T(&#39;\n&#39;))
            buffer.RemoveLast();
        wxString cmdString = cmd-&gt;m_Cmd;               /*trap*/
        if (cmdString.StartsWith(_T(&quot;delete &quot;))) asm(&quot;int3&quot;); /*trap*/
        cmd-&gt;ParseOutput(buffer.Left(idx));
        delete cmd;
        RunQueue();
    }



This is the culprit: line 508 in gdb_commands.h . m_BP has alread been deleted.

            // invalidate bp number
            m_BP-&gt;index = -1;
</pre></div>

      <h4 class="page-header">History</h4>
      <div class="panel panel-default">
        <div class="panel-heading">mandrav 2008-02-02 12:09</div>
        <div class="panel-body">
          <p>I don't see if this is a patch or not, but I do see what you mean.</p>
          <p>Have you tried commenting out gdb_commands.h:508?</p>
          <p>Does this fix the problem?</p>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">pecan 2008-02-02 16:45</div>
        <div class="panel-body">
          <pre class="pre-scrollable">I accidently used the wrong URL to post this. But I don't know how to move it.

Yes, commenting out:

            // invalidate bp number
            m_BP-&gt;index = -1;

at gdb_command.h:508 solved the problem.</pre>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">pecan 2008-02-16 00:05</div>
        <div class="panel-body">
          <p>Fixed</p>
        </div>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
  </body>
</html>
